<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Demo Bank — Firebase (USD)</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<style>
:root{--accent-1:#4e54c8;--accent-2:#8f94fb;--accent-3:#667eea;--accent-4:#764ba2;}
html,body{height:100%;margin:0;font-family:Inter, 'Segoe UI', system-ui, Roboto, "Helvetica Neue", Arial;}
body{background:linear-gradient(135deg,var(--accent-1),var(--accent-2));color:#222;-webkit-font-smoothing:antialiased;}
.section{display:none;padding:18px 18px 90px;}
.section.active{display:block;}
.login-card{max-width:420px;margin:64px auto;background:#fff;border-radius:14px;padding:28px;box-shadow:0 18px 50px rgba(0,0,0,.25);}
.btn-primary{background:linear-gradient(135deg,var(--accent-1),var(--accent-2));border:0;color:#fff;box-shadow:0 8px 30px rgba(0,0,0,.18);border-radius:10px;padding:10px 14px;}
.btn-success{background:linear-gradient(135deg,#43e97b,#38f9d7);border:0;color:#fff;border-radius:10px;padding:10px 14px;}
.btn-danger{background:linear-gradient(135deg,#f5576c,#f093fb);border:0;color:#fff;border-radius:10px;padding:10px 14px;}
.navbar{height:58px;background:#fff;border-radius:8px;display:flex;align-items:center;justify-content:space-between;padding:0 12px;box-shadow:0 6px 18px rgba(0,0,0,.12);}
.navbar .icon{font-size:22px;color:var(--accent-4);cursor:pointer}
.profile-icon{font-size:26px;color:var(--accent-4);cursor:pointer}
.balance-card{background:linear-gradient(135deg,var(--accent-3),var(--accent-4));color:#fff;border-radius:14px;padding:18px;margin:14px 0;box-shadow:0 12px 40px rgba(0,0,0,.22)}
.card-custom{background:#fff;border-radius:12px;padding:14px;box-shadow:0 8px 28px rgba(0,0,0,.12);cursor:pointer;margin:8px}
.card-custom h5{margin:0;font-size:15px;font-weight:600}
.card-custom p{margin:6px 0 0;color:#666}
.bottom-nav{position:fixed;left:0;right:0;bottom:14px;margin:auto;display:flex;gap:18px;justify-content:center;pointer-events:auto;}
.bottom-nav button{width:64px;height:64px;border-radius:32px;border:0;box-shadow:0 10px 30px rgba(0,0,0,.18);display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer}
.menu{position:fixed;left:-290px;top:0;height:100%;width:270px;background:#fff;box-shadow:4px 0 30px rgba(0,0,0,.2);padding-top:64px;transition:left .22s;}
.menu.show{left:0}
.menu a{display:flex;align-items:center;padding:12px 16px;color:#333;text-decoration:none;border-bottom:1px solid #f2f2f2}
.menu a i{font-size:18px;margin-right:12px;color:var(--accent-4)}
.profile-pic{width:78px;height:78px;border-radius:50%;object-fit:cover;border:3px solid #fff;box-shadow:0 6px 22px rgba(0,0,0,.18)}
.success-card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 12px 34px rgba(0,0,0,.14);max-width:560px;margin:18px auto;color:#222}
.receipt-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f0f0f0}
.small-muted{font-size:13px;color:#666}
.spinner{display:flex;justify-content:center;align-items:center;padding:40px}
.spinner .dot{width:48px;height:48px;border-radius:50%;border:6px solid rgba(255,255,255,.18);border-top-color:#fff;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
input,select,textarea{border-radius:10px;padding:10px;border:1px solid #e6e6e6;box-shadow:inset 0 1px 2px rgba(0,0,0,.03);width:100%}
label{font-weight:600;font-size:14px;color:#333}
.link-like{color:var(--accent-4);cursor:pointer}
.muted{color:#777;font-size:13px}
@media (min-width:900px){.section{max-width:980px;margin:0 auto}}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginSection" class="section active">
  <div class="login-card text-center">
    <h3 class="mb-3" style="font-weight:700;">Demo Bank</h3>
    <p class="muted mb-4">Login with Email</p>
    <input type="email" id="loginEmail" placeholder="Email" class="mb-3">
    <input type="password" id="loginPassword" placeholder="Password" class="mb-3">
    <button class="btn btn-primary w-100" id="loginBtn">Login</button>
    <div class="mt-3">
      <span class="link-like" id="goToSignup">Create Account</span>
    </div>
    <div id="loginError" class="text-danger mt-3" style="display:none;">Invalid email or password</div>
  </div>
</div>

<!-- SIGNUP -->
<div id="signupSection" class="section">
  <div class="login-card text-center">
    <h3 class="mb-3" style="font-weight:700;">Create Account</h3>
    <input type="text" id="signupName" placeholder="Full Name" class="mb-3">
    <input type="email" id="signupEmail" placeholder="Email" class="mb-3">
    <input type="password" id="signupPassword" placeholder="Password" class="mb-3">
    <button class="btn btn-primary w-100" id="signupBtn">Create Account</button>
    <div class="mt-3"><span class="link-like" id="backToLogin">← Back to Login</span></div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboardSection" class="section">
  <div class="navbar mb-3">
    <i class="bi bi-list icon" id="menuToggle"></i>
    <i class="bi bi-person-circle profile-icon" id="openProfile"></i>
  </div>

  <div class="balance-card text-center">
    <div id="greeting" style="font-size:18px;font-weight:600;"></div>
    <div class="small-muted" id="liveTime"></div>
    <h2 id="overallBalance" style="margin-top:15px;font-weight:700;"></h2>
    <div class="small-muted">Overview Balance (USD)</div>
  </div>

  <h5 style="font-weight:700;margin-top:18px;">Accounts</h5>
  <div class="card-custom" id="checkingCard"><h5>Checking Account</h5><p id="checkingBalance"></p></div>
  <div class="card-custom" id="savingsCard"><h5>Savings Account</h5><p id="savingsBalance"></p></div>

  <h5 style="font-weight:700;margin-top:18px;">Actions</h5>
  <div class="card-custom" id="internalTransferBtn"><h5><i class="bi bi-arrow-left-right"></i> Transfer Between Accounts</h5></div>
  <div class="card-custom" id="sendMoneyBtn"><h5><i class="bi bi-send"></i> Send Money</h5></div>
  <div class="card-custom" id="topupBtn"><h5><i class="bi bi-plus-lg"></i> Top Up</h5></div>
  <div class="card-custom" id="withdrawBtn"><h5><i class="bi bi-wallet2"></i> Withdraw</h5></div>
  <div class="card-custom" id="transactionsBtn"><h5><i class="bi bi-list-check"></i> Transaction History</h5></div>
</div>

<!-- INTERNAL TRANSFER -->
<div id="internalSection" class="section">
  <h3 style="font-weight:700;">Internal Transfer</h3>
  <label>From</label>
  <select id="itFrom"><option value="checking">Checking</option><option value="savings">Savings</option></select>
  <label class="mt-3">To</label>
  <select id="itTo"><option value="savings">Savings</option><option value="checking">Checking</option></select>
  <label class="mt-3">Amount (USD)</label>
  <input type="number" id="itAmount" placeholder="0.00">
  <div class="mt-4 text-center"><button class="btn btn-primary w-100" id="itSubmit">Transfer</button></div>
  <div class="mt-4 text-center"><span class="link-like" id="itBack">← Back to Dashboard</span></div>
</div>

<!-- SEND -->
<div id="sendSection" class="section">
  <h3 style="font-weight:700;">Send Money</h3>
  <label class="mt-3">Recipient Account Number</label>
  <input id="sendAcc" placeholder="Account Number">
  <label class="mt-3">Amount (USD)</label>
  <input type="number" id="sendAmount" placeholder="0.00">
  <div class="mt-4 text-center"><button class="btn btn-primary w-100" id="sendSubmit">Send</button></div>
  <div class="mt-4 text-center"><span class="link-like" id="sendBack">← Back to Dashboard</span></div>
</div>

<!-- TOPUP -->
<div id="topupSection" class="section">
  <h3 style="font-weight:700;">Top Up</h3>
  <label class="mt-3">Amount (USD)</label>
  <input type="number" id="topupAmount" placeholder="0.00">
  <div class="mt-4 text-center"><button class="btn btn-success w-100" id="topupSubmit">Top Up</button></div>
  <div class="mt-4 text-center"><span class="link-like" id="topupBack">← Back to Dashboard</span></div>
</div>

<!-- WITHDRAW -->
<div id="withdrawSection" class="section">
  <h3 style="font-weight:700;">Withdraw</h3>
  <label class="mt-3">Amount (USD)</label>
  <input type="number" id="withdrawAmount" placeholder="0.00">
  <div class="mt-4 text-center"><button class="btn btn-danger w-100" id="withdrawSubmit">Withdraw</button></div>
  <div class="mt-4 text-center"><span class="link-like" id="withdrawBack">← Back to Dashboard</span></div>
</div>

<!-- TRANSACTIONS -->
<div id="transactionSection" class="section">
  <h3 style="font-weight:700;">Transaction History</h3>
  <div id="transactionList" style="margin-top:20px;"></div>
  <div class="mt-4 text-center"><span class="link-like" id="transactionBack">← Back to Dashboard</span></div>
</div>

<!-- PROFILE -->
<div id="profileSection" class="section text-center">
  <h3 style="font-weight:700;">Profile</h3>
  <div style="text-align:center; margin-bottom:20px;">
    <img src="" id="profilePic" class="profile-pic" alt="Profile Picture">
    <div class="mt-2"><input type="file" id="uploadProfilePic"></div>
  </div>
  <label>Name</label><input type="text" id="profileName">
  <label>Email</label><input type="email" id="profileEmail">
  <label>Phone Number</label><input type="text" id="profilePhone">
  <button class="btn btn-primary w-100 mt-3" id="saveProfileBtn">Save Profile</button>
  <div class="mt-4 text-center"><span class="link-like" id="profileBack">← Back to Dashboard</span></div>
</div>

<!-- SIDE MENU -->
<div id="sideMenu" class="menu">
  <a href="#" id="menuDashboard"><i class="bi bi-house-door"></i> Dashboard</a>
  <a href="#" id="menuProfile"><i class="bi bi-person"></i> Profile</a>
  <a href="#" id="menuTransactions"><i class="bi bi-list-check"></i> Transactions</a>
  <a href="#" id="menuLogout"><i class="bi bi-box-arrow-right"></i> Logout</a>
</div>

<!-- LOADING & SUCCESS -->
<div id="loadingScreen" style="display:none; text-align:center; padding:30px;">
  <div class="spinner" style="margin:auto; width:60px; height:60px;"></div>
  <h3 style="margin-top:20px;">Processing...</h3>
</div>

<div id="successScreen" style="display:none; padding:25px;">
  <div style="text-align:center; font-size:32px; margin-bottom:20px;">✅</div>
  <h2 style="text-align:center; margin-bottom:10px;">Transaction Successful</h2>
  <div id="successDetails" style="background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.12); font-size:16px; line-height:26px;"></div>
  <button onclick="returnToDashboard()" style="width:100%; margin-top:25px; padding:15px; border:none; border-radius:10px; background:#4b6bfb; color:#fff; font-size:18px;">Back to Dashboard</button>
</div>

<!-- Firebase compat SDKs (browser-friendly) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ---------- Use your Firebase config (from you) ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyAjy5sgZPMFsklKkSOMyC1HCvQ4-qNKP-M",
  authDomain: "fir-bank-c659f.firebaseapp.com",
  projectId: "fir-bank-c659f",
  storageBucket: "fir-bank-c659f.firebasestorage.app",
  messagingSenderId: "847611883266",
  appId: "1:847611883266:web:651ecee5dfea8e0f1cdc1b",
  measurementId: "G-QK7R83FC51"
};
/* -------------------------------------------------------- */

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ----------------- GLOBAL STATE ----------------- */
let currentUid = null;
let currentAccountNumber = null;
let checkingBalance = 0;
let savingsBalance = 0;

/* ----------------- UI HELPERS ----------------- */
function showSection(id){
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
  const el=document.getElementById(id);
  if(el) el.classList.add("active");
  document.getElementById("loadingScreen").style.display="none";
  document.getElementById("successScreen").style.display="none";
}
function usd(n){ return "$"+Number(n||0).toFixed(2); }
function setGreeting(name){
  const hour=new Date().getHours();
  let greet="Hello";
  if(hour<12) greet="Good Morning";
  else if(hour<18) greet="Good Afternoon";
  else greet="Good Evening";
  document.getElementById("greeting").innerText = `${greet} ${name||""}`;
  document.getElementById("liveTime").innerText = new Date().toLocaleTimeString();
}
function updateBalancesUI(){
  document.getElementById("checkingBalance").innerText = usd(checkingBalance);
  document.getElementById("savingsBalance").innerText = usd(savingsBalance);
  document.getElementById("overallBalance").innerText = usd((checkingBalance||0)+(savingsBalance||0));
}

/* ----------------- AUTH LISTENER ----------------- */
auth.onAuthStateChanged(async user=>{
  if(user){
    currentUid = user.uid;
    // load user doc
    const udoc = await db.collection("users").doc(currentUid).get();
    if(udoc.exists){
      const d = udoc.data();
      currentAccountNumber = d.accountNumber || null;
      checkingBalance = d.checking || 0;
      savingsBalance = d.savings || 0;
      updateBalancesUI();
      setGreeting(d.name);
      // start realtime snapshot on user doc
      db.collection("users").doc(currentUid).onSnapshot(snap=>{
        if(!snap.exists) return;
        const data = snap.data();
        checkingBalance = data.checking || 0;
        savingsBalance = data.savings || 0;
        updateBalancesUI();
        setGreeting(data.name);
        // refresh tx list if open
        if(document.getElementById("transactionSection").classList.contains("active")) loadTransactions();
      });
      showSection("dashboardSection");
    } else {
      // strange: no user doc found — force sign out
      await auth.signOut();
    }
  } else {
    currentUid = null;
    currentAccountNumber = null;
    showSection("loginSection");
  }
});

/* ----------------- NAVIGATION ----------------- */
document.getElementById("goToSignup").addEventListener("click", ()=> showSection("signupSection"));
document.getElementById("backToLogin").addEventListener("click", ()=> showSection("loginSection"));
document.getElementById("menuToggle").addEventListener("click", ()=> document.getElementById("sideMenu").classList.toggle("show"));
document.getElementById("openProfile").addEventListener("click", ()=> { showSection("profileSection"); loadProfile(); });
document.getElementById("profileBack").addEventListener("click", ()=> showSection("dashboardSection"));
document.getElementById("internalTransferBtn").addEventListener("click", ()=> showSection("internalSection"));
document.getElementById("itBack").addEventListener("click", ()=> showSection("dashboardSection"));
document.getElementById("sendMoneyBtn").addEventListener("click", ()=> showSection("sendSection"));
document.getElementById("sendBack").addEventListener("click", ()=> showSection("dashboardSection"));
document.getElementById("topupBtn").addEventListener("click", ()=> showSection("topupSection"));
document.getElementById("topupBack").addEventListener("click", ()=> showSection("dashboardSection"));
document.getElementById("withdrawBtn").addEventListener("click", ()=> showSection("withdrawSection"));
document.getElementById("withdrawBack").addEventListener("click", ()=> showSection("dashboardSection"));
document.getElementById("transactionsBtn").addEventListener("click", ()=> { showSection("transactionSection"); loadTransactions(); });
document.getElementById("transactionBack").addEventListener("click", ()=> showSection("dashboardSection"));

/* ----------------- SIGNUP (email/password) -----------------*/
function genAccountNumber(){ return "AC"+Math.floor(100000000 + Math.random()*900000000); }

document.getElementById("signupBtn").addEventListener("click", async ()=>{
  const name = document.getElementById("signupName").value.trim();
  const email = document.getElementById("signupEmail").value.trim();
  const password = document.getElementById("signupPassword").value;

  if(!name || !email || !password){ alert("Fill name, email and password"); return; }

  try{
    // create auth user
    const cred = await auth.createUserWithEmailAndPassword(email, password);
    const uid = cred.user.uid;

    // generate unique account number (very small chance of collision)
    let acc = genAccountNumber();
    let tries = 0;
    while(tries < 6){
      const snap = await db.collection("users").where("accountNumber","==",acc).get();
      if(snap.empty) break;
      acc = genAccountNumber();
      tries++;
    }

    // create user document keyed by uid
    await db.collection("users").doc(uid).set({
      name, email, accountNumber: acc,
      checking: 5000, savings: 3000,
      transactions: [], phone: "", profilePic: ""
    });

    alert(`Account created! Your account number is ${acc}. Keep it safe.`);
    // user is already logged in by auth; onAuthStateChanged will handle UI
  }catch(err){
    alert("Signup error: "+err.message);
  }
});

/* ----------------- LOGIN (email/password) -----------------*/
document.getElementById("loginBtn").addEventListener("click", async ()=>{
  const email = document.getElementById("loginEmail").value.trim();
  const password = document.getElementById("loginPassword").value;
  if(!email || !password){ alert("Enter email & password"); return; }
  try{
    await auth.signInWithEmailAndPassword(email, password);
    // onAuthStateChanged will load user doc and show dashboard
  }catch(err){
    document.getElementById("loginError").style.display="block";
    document.getElementById("loginError").innerText = "Login failed: " + err.message;
  }
});

/* ----------------- PROFILE -----------------*/
const profilePicEl = document.getElementById("profilePic");
document.getElementById("uploadProfilePic")?.addEventListener("change", e=>{
  if(!e.target.files || !e.target.files[0]) return;
  const reader = new FileReader();
  reader.onload = ()=> profilePicEl.src = reader.result;
  reader.readAsDataURL(e.target.files[0]);
});

async function loadProfile(){
  if(!currentUid) return;
  const snap = await db.collection("users").doc(currentUid).get();
  if(!snap.exists) return;
  const d = snap.data();
  document.getElementById("profileName").value = d.name || "";
  document.getElementById("profileEmail").value = d.email || "";
  document.getElementById("profilePhone").value = d.phone || "";
  if(d.profilePic) profilePicEl.src = d.profilePic;
}

document.getElementById("saveProfileBtn").addEventListener("click", async ()=>{
  if(!currentUid) return;
  const updates = {
    name: document.getElementById("profileName").value,
    email: document.getElementById("profileEmail").value,
    phone: document.getElementById("profilePhone").value
  };
  if(profilePicEl.src) updates.profilePic = profilePicEl.src;
  await db.collection("users").doc(currentUid).update(updates);
  // if email changed, update auth email too
  const newEmail = updates.email;
  const user = auth.currentUser;
  if(user && newEmail && user.email !== newEmail){
    try{ await user.updateEmail(newEmail); } catch(e){ console.warn("Auth email update failed:",e.message); }
  }
  alert("Profile saved");
});

/* ----------------- TRANSACTION HELPERS -----------------*/
function createReceiptHTML(title, amount, fee, total, fromAcc, toAcc){
  return `<h3>${title}</h3>
    <p><strong>Transaction ID:</strong> TX-${Math.floor(Math.random()*999999)}</p>
    <p><strong>Date:</strong> ${new Date().toLocaleString()}</p>
    <p><strong>Amount:</strong> ${usd(amount)}</p>
    <p><strong>Fee:</strong> ${usd(fee)}</p>
    <p><strong>Total Deducted:</strong> ${usd(total)}</p>
    <p><strong>From:</strong> ${fromAcc}</p>
    <p><strong>To:</strong> ${toAcc}</p>`;
}

function showLoadingThenSuccess(receiptHTML){
  document.getElementById("loadingScreen").style.display="block";
  setTimeout(()=>{
    document.getElementById("loadingScreen").style.display="none";
    document.getElementById("successDetails").innerHTML = receiptHTML;
    showSection("successScreen");
  },900);
}
function returnToDashboard(){ showSection("dashboardSection"); }

/* ----------------- INTERNAL TRANSFER -----------------*/
document.getElementById("itSubmit").addEventListener("click", async ()=>{
  const from = document.getElementById("itFrom").value;
  const to = document.getElementById("itTo").value;
  const amount = parseFloat(document.getElementById("itAmount").value);
  if(!amount || amount <= 0){ alert("Enter valid amount"); return; }
  if(from === to){ alert("Choose different accounts"); return; }
  const fee = amount * 0.05;
  const total = amount + fee;
  const ref = db.collection("users").doc(currentUid);
  const snap = await ref.get();
  const data = snap.data();
  if((data[from] || 0) < total){ alert("Insufficient funds"); return; }
  await ref.update({
    [from]: (data[from] || 0) - total,
    [to]: (data[to] || 0) + amount,
    transactions: firebase.firestore.FieldValue.arrayUnion({
      type: "Internal Transfer", from, to, amount, fee, total, date: new Date().toISOString()
    })
  });
  const receipt = createReceiptHTML("Internal Transfer", amount, fee, total, from, to);
  showLoadingThenSuccess(receipt);
});

/* ----------------- TOP UP -----------------*/
document.getElementById("topupSubmit").addEventListener("click", async ()=>{
  const amount = parseFloat(document.getElementById("topupAmount").value);
  if(!amount || amount<=0){ alert("Enter valid amount"); return; }
  const fee = amount * 0.05;
  const total = amount + fee;
  const ref = db.collection("users").doc(currentUid);
  const snap = await ref.get();
  const data = snap.data();
  await ref.update({
    checking: (data.checking || 0) + amount,
    transactions: firebase.firestore.FieldValue.arrayUnion({
      type: "Top-Up", from: "Card/External", to: "Checking", amount, fee, total, date: new Date().toISOString()
    })
  });
  const receipt = createReceiptHTML("Top-Up", amount, fee, total, "Card/External", "Checking");
  showLoadingThenSuccess(receipt);
});

/* ----------------- WITHDRAW -----------------*/
document.getElementById("withdrawSubmit").addEventListener("click", async ()=>{
  const amount = parseFloat(document.getElementById("withdrawAmount").value);
  if(!amount || amount<=0){ alert("Enter valid amount"); return; }
  const fee = amount * 0.05;
  const total = amount + fee;
  const ref = db.collection("users").doc(currentUid);
  const snap = await ref.get();
  const data = snap.data();
  if((data.checking || 0) < total){ alert("Insufficient funds"); return; }
  await ref.update({
    checking: (data.checking || 0) - total,
    transactions: firebase.firestore.FieldValue.arrayUnion({
      type: "Withdraw", from: "Checking", to: "Card/Bank", amount, fee, total, date: new Date().toISOString()
    })
  });
  const receipt = createReceiptHTML("Withdraw", amount, fee, total, "Checking", "Card/Bank");
  showLoadingThenSuccess(receipt);
});

/* ----------------- SEND MONEY -----------------*/
document.getElementById("sendSubmit").addEventListener("click", async ()=>{
  const recipientAcc = document.getElementById("sendAcc").value.trim();
  const amount = parseFloat(document.getElementById("sendAmount").value);
  if(!recipientAcc || !amount || amount<=0){ alert("Enter valid data"); return; }
  // find recipient uid by accountNumber
  const q = await db.collection("users").where("accountNumber","==",recipientAcc).get();
  if(q.empty){ alert("Recipient not found"); return; }
  const recipientDoc = q.docs[0];
  const recipientRef = db.collection("users").doc(recipientDoc.id);
  const senderRef = db.collection("users").doc(currentUid);
  const sSnap = await senderRef.get();
  const rSnap = await recipientRef.get();
  const fee = amount * 0.05;
  const total = amount + fee;
  if((sSnap.data().checking || 0) < total){ alert("Insufficient funds"); return; }

  // update sender and receiver (demo non-transactional approach)
  await senderRef.update({
    checking: (sSnap.data().checking || 0) - total,
    transactions: firebase.firestore.FieldValue.arrayUnion({
      type: "Sent", to: recipientAcc, amount, fee, total, date: new Date().toISOString()
    })
  });
  await recipientRef.update({
    checking: (rSnap.data().checking || 0) + amount,
    transactions: firebase.firestore.FieldValue.arrayUnion({
      type: "Received", from: sSnap.data().accountNumber || "?", amount, date: new Date().toISOString()
    })
  });

  const receipt = createReceiptHTML("Sent Money", amount, fee, total, sSnap.data().accountNumber || "You", recipientAcc);
  showLoadingThenSuccess(receipt);
});

/* ----------------- TRANSACTION HISTORY -----------------*/
async function loadTransactions(){
  if(!currentUid) return;
  const snap = await db.collection("users").doc(currentUid).get();
  const container = document.getElementById("transactionList");
  container.innerHTML = "";
  const data = snap.data();
  if(!data || !data.transactions || data.transactions.length===0){
    container.innerHTML = "<p class='muted'>No transactions yet</p>";
    return;
  }
  const tx = data.transactions.slice().reverse();
  tx.forEach(t=>{
    const div = document.createElement("div");
    div.className = "card-custom";
    div.style.marginBottom = "8px";
    div.innerHTML = `<h5 style="margin-bottom:6px;">${t.type}</h5>
      <div style="display:flex;justify-content:space-between">
        <div><small class="small-muted">${t.from?("From: "+t.from):""} ${t.to?("To: "+t.to):""}</small></div>
        <div><strong>${usd(t.amount)}</strong></div>
      </div>
      <div class="small-muted" style="margin-top:6px;">${new Date(t.date).toLocaleString()}</div>`;
    container.appendChild(div);
  });
}

/* ----------------- SIDE MENU NAVIGATION -----------------*/
document.getElementById("menuDashboard")?.addEventListener("click", (e)=> {
  e.preventDefault();
  if(!currentUid) return;
  showSection("dashboardSection");
  document.getElementById("sideMenu").classList.remove("show");
});
document.getElementById("menuProfile")?.addEventListener("click", (e)=> {
  e.preventDefault();
  if(!currentUid) return;
  showSection("profileSection");
  loadProfile();
  document.getElementById("sideMenu").classList.remove("show");
});
document.getElementById("menuTransactions")?.addEventListener("click", (e)=> {
  e.preventDefault();
  if(!currentUid) return;
  showSection("transactionSection");
  loadTransactions();
  document.getElementById("sideMenu").classList.remove("show");
});
document.getElementById("menuLogout")?.addEventListener("click", async (e)=> {
  e.preventDefault();
  if(!currentUid) return;
  await auth.signOut();
  document.getElementById("sideMenu").classList.remove("show");
});

/* ----------------- utility init -----------------*/
document.getElementById("itFrom").value = "checking";
document.getElementById("itTo").value = "savings";

/* ----------------- END -----------------*/
</script>
</body>
</html>