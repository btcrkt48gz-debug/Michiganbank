<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OlaCreditUnion — Demo Bank</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{ --accent-1:#4e54c8; --accent-2:#8f94fb; --accent-3:#667eea; --accent-4:#764ba2; }
    html,body{ height:100%; margin:0; font-family:Inter,system-ui,Roboto,Arial; }
    body{ background:linear-gradient(135deg,var(--accent-1),var(--accent-2)); color:#222; -webkit-font-smoothing:antialiased; }
    .section{ display:none; padding:18px 18px 110px; }
    .section.active{ display:block; }
    .login-card{ max-width:480px; margin:48px auto; background:#fff; border-radius:14px; padding:26px; box-shadow:0 18px 50px rgba(0,0,0,.15); }
    .btn-primary{ background:linear-gradient(135deg,var(--accent-1),var(--accent-2)); border:0; color:#fff; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:600; transition:all 0.2s ease; box-shadow:0 4px 15px rgba(78,84,200,0.3); }
    .btn-primary:hover{ transform:translateY(-2px); box-shadow:0 6px 20px rgba(78,84,200,0.4); }
    .btn-primary:active{ transform:translateY(0); box-shadow:0 2px 8px rgba(78,84,200,0.3); }
    .btn-success{ background:linear-gradient(135deg,#43e97b,#38f9d7); border:0; color:#fff; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:600; transition:all 0.2s ease; box-shadow:0 4px 15px rgba(67,233,123,0.3); }
    .btn-success:hover{ transform:translateY(-2px); box-shadow:0 6px 20px rgba(67,233,123,0.4); }
    .btn-success:active{ transform:translateY(0); box-shadow:0 2px 8px rgba(67,233,123,0.3); }
    .btn-danger{ background:linear-gradient(135deg,#f5576c,#f093fb); border:0; color:#fff; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:600; transition:all 0.2s ease; box-shadow:0 4px 15px rgba(245,87,108,0.3); }
    .btn-danger:hover{ transform:translateY(-2px); box-shadow:0 6px 20px rgba(245,87,108,0.4); }
    .btn-danger:active{ transform:translateY(0); box-shadow:0 2px 8px rgba(245,87,108,0.3); }
    button{ transition:all 0.2s ease; }
    .navbar{ height:58px; background:#fff; border-radius:8px; display:flex; align-items:center; justify-content:space-between; padding:0 12px; box-shadow:0 6px 18px rgba(0,0,0,.12); }
    .balance-card{ background:linear-gradient(135deg,var(--accent-3),var(--accent-4)); color:#fff; border-radius:14px; padding:18px; margin:14px 0; box-shadow:0 12px 40px rgba(0,0,0,.18); }
    .card-custom{ background:#fff; border-radius:12px; padding:14px; box-shadow:0 8px 28px rgba(0,0,0,.12); cursor:pointer; margin:8px; transition:all 0.2s ease; }
    .card-custom:hover{ transform:translateY(-3px); box-shadow:0 12px 35px rgba(0,0,0,.18); }
    .card-custom:active{ transform:scale(.98); }
    input,select,textarea{ border-radius:10px; padding:10px; border:1px solid #e6e6e6; width:100%; }
    label{ font-weight:600; font-size:14px; color:#333; }
    .muted{ color:#777; font-size:13px; }
    .masked{ letter-spacing:2px; font-weight:600; }
    .copy-btn{ cursor:pointer; margin-left:8px; }
    .error{ color:#d9534f; font-size:14px; }
    .link-like{ cursor:pointer; color:var(--accent-4); text-decoration:underline; transition:all 0.2s ease; }
    .link-like:hover{ color:var(--accent-1); text-decoration-thickness:2px; }
    .menu-overlay{ display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,.5); z-index:100; }
    .menu-overlay.open{ display:block; }
    .menu-panel{ display:none; position:fixed; top:0; left:0; width:280px; height:100%; background:#fff; z-index:101; box-shadow:4px 0 12px rgba(0,0,0,.2); }
    .menu-panel.open{ display:flex; flex-direction:column; padding:20px; gap:12px; }
    .menu-item{ padding:12px; border-radius:8px; cursor:pointer; background:#f5f5f5; text-align:center; font-weight:600; transition:all 0.2s ease; box-shadow:0 2px 6px rgba(0,0,0,.08); }
    .menu-item:hover{ background:var(--accent-1); color:#fff; transform:translateX(4px); box-shadow:0 4px 12px rgba(78,84,200,0.3); }
    .menu-item:active{ transform:translateX(2px); }
    .crypto-price-card{ background:#fff; border-radius:12px; padding:14px; margin:8px 0; box-shadow:0 4px 12px rgba(0,0,0,.08); }
    .price-up{ color:#43e97b; font-weight:600; }
    .price-down{ color:#f5576c; font-weight:600; }
    @media (min-width:900px){ .section{ max-width:980px; margin:0 auto; } }
  </style>
</head>
<body>

  <!-- MENU OVERLAY -->
  <div id="menuOverlay" class="menu-overlay"></div>

  <!-- HAMBURGER MENU -->
  <div id="menuPanel" class="menu-panel">
    <div style="font-weight:700;margin-bottom:20px;font-size:18px;">Menu</div>
    <div id="transactionsMenuItem" class="menu-item"><i class="bi bi-receipt me-2"></i>Transactions</div>
    <div id="cryptoMenuItem" class="menu-item"><i class="bi bi-coin me-2"></i>Buy Crypto</div>
    <div id="profileMenuItem" class="menu-item"><i class="bi bi-person me-2"></i>Profile</div>
    <div id="logoutMenuItem" class="menu-item"><i class="bi bi-box-arrow-right me-2"></i>Logout</div>
  </div>

  <!-- LOGIN/SIGNUP -->
  <div id="authSection" class="section active">
    <div class="login-card text-center">
      <h3 style="font-weight:700;margin-bottom:6px;">OlaCreditUnion — Demo</h3>
      <p class="muted">Sign in or create account</p>
      <div id="authTabs" class="mb-3">
        <button id="showLogin" class="btn btn-sm btn-light me-2">Login</button>
        <button id="showSignup" class="btn btn-sm btn-light">Sign up</button>
      </div>
      <form id="loginBox" onsubmit="return false">
        <input id="loginEmail" placeholder="Email" class="mb-2 form-control" />
        <input id="loginPassword" type="password" placeholder="Password" class="mb-2 form-control" />
        <button id="loginBtn" type="button" class="btn btn-primary w-100 mb-2">Login</button>
        <div id="loginError" class="error" style="display:none"></div>
      </form>
      <form id="signupBox" style="display:none" onsubmit="return false">
        <input id="signupName" placeholder="Full name" class="mb-2 form-control" />
        <input id="signupEmail" placeholder="Email" class="mb-2 form-control" />
        <input id="signupPassword" type="password" placeholder="Password" class="mb-2 form-control" />
        <input id="signupPin" type="password" placeholder="Transaction PIN (4 digits)" class="mb-2 form-control" maxlength="6"/>
        <button id="signupBtn" type="button" class="btn btn-success w-100 mb-2">Create account</button>
        <div id="signupError" class="error" style="display:none"></div>
      </form>
      <div class="mt-2 muted">Demo app. No real money moves.</div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboardSection" class="section">
    <div class="navbar mb-3">
      <i id="menuToggle" class="bi bi-list" style="font-size:22px;color:var(--accent-4);cursor:pointer"></i>
      <img id="topProfilePic" src="" style="width:36px;height:36px;border-radius:18px;object-fit:cover" />
    </div>
    <div class="balance-card text-center">
      <div id="greeting" style="font-size:18px;font-weight:700"></div>
      <div class="muted" id="liveTime"></div>
      <h2 id="overallBalance" style="margin-top:12px;font-weight:800"></h2>
      <div class="muted">Overall Balance (USD)</div>
      <div class="mt-3">
        <span id="acctMasked" class="masked"></span>
        <i class="bi bi-clipboard copy-btn" id="copyAcct" title="Copy account"></i>
      </div>
    </div>
    <h5 style="font-weight:700;margin-top:12px">Accounts</h5>
    <div class="card-custom" id="checkingCard" style="cursor:pointer;">
      <h5>Checking</h5>
      <p id="checkingBal" style="font-weight:700"></p>
    </div>
    <div class="card-custom" id="savingsCard" style="cursor:pointer;">
      <h5>Savings</h5>
      <p id="savingsBal" style="font-weight:700"></p>
    </div>
    <div class="card-custom" id="cryptoCard" style="cursor:pointer;">
      <h5>Crypto Wallet</h5>
      <p id="cryptoHoldings" style="font-weight:700">BTC: 0 | ETH: 0 | LTC: 0</p>
    </div>
    <h5 style="font-weight:700;margin-top:12px">Transactions</h5>
    <div class="d-grid gap-2">
      <button class="btn btn-light card-custom text-start" id="sendBtn"><i class="bi bi-send me-2"></i> Send Money</button>
      <button class="btn btn-light card-custom text-start" id="topupBtn"><i class="bi bi-plus-circle me-2"></i> Top Up</button>
      <button class="btn btn-light card-custom text-start" id="withdrawBtn"><i class="bi bi-arrow-down-circle me-2"></i> Withdraw</button>
      <button class="btn btn-light card-custom text-start" id="wireBtn"><i class="bi bi-globe me-2"></i> Wire Transfer</button>
      <button class="btn btn-light card-custom text-start" id="cryptoBtn"><i class="bi bi-coin me-2"></i> Buy Crypto</button>
    </div>

    <!-- Bottom Navigation -->
    <div id="bottomNav" style="position:fixed;left:0;right:0;bottom:14px;display:flex;gap:18px;justify-content:center;z-index:20">
      <button id="navSend" style="width:64px;height:64px;border-radius:32px;border:0;box-shadow:0 10px 30px rgba(0,0,0,.16);display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;background:white;"><i class="bi bi-send"></i></button>
      <button id="navTop" style="width:64px;height:64px;border-radius:32px;border:0;box-shadow:0 10px 30px rgba(0,0,0,.16);display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;background:white;"><i class="bi bi-plus-lg"></i></button>
      <button id="navWithdraw" style="width:64px;height:64px;border-radius:32px;border:0;box-shadow:0 10px 30px rgba(0,0,0,.16);display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;background:white;"><i class="bi bi-wallet2"></i></button>
    </div>
  </div>

  <!-- TRANSACTIONS -->
  <div id="transactionsSection" class="section">
    <div class="card-custom">
      <h5 id="transactionsTitle">Transaction History</h5>
      <div id="transactionsList" style="margin-top:16px;max-height:600px;overflow-y:auto;">
        <p class="muted text-center">Loading transactions...</p>
      </div>
      <div class="mt-3"><span class="link-like" id="transactionsBack">← Back to Dashboard</span></div>
    </div>
  </div>

  <!-- CRYPTO LIST -->
  <div id="cryptoListSection" class="section">
    <div class="card-custom">
      <h5>Select Cryptocurrency</h5>
      <div style="margin-top:16px;display:grid;gap:12px;">
        <div id="bitcoinCard" class="crypto-price-card" style="cursor:pointer;padding:16px;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div><strong>Bitcoin</strong><br><span class="muted">BTC</span></div>
            <div style="text-align:right;"><span id="btcPrice">$0.00</span><br><span id="btcChange" class="muted">0%</span></div>
          </div>
        </div>
        <div id="ethereumCard" class="crypto-price-card" style="cursor:pointer;padding:16px;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div><strong>Ethereum</strong><br><span class="muted">ETH</span></div>
            <div style="text-align:right;"><span id="ethPrice">$0.00</span><br><span id="ethChange" class="muted">0%</span></div>
          </div>
        </div>
        <div id="litecoinCard" class="crypto-price-card" style="cursor:pointer;padding:16px;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div><strong>Litecoin</strong><br><span class="muted">LTC</span></div>
            <div style="text-align:right;"><span id="ltcPrice">$0.00</span><br><span id="ltcChange" class="muted">0%</span></div>
          </div>
        </div>
      </div>
      <div class="mt-3"><span class="link-like" id="cryptoListBack">← Back</span></div>
    </div>
  </div>

  <!-- BITCOIN DETAIL -->
  <div id="bitcoinDetailSection" class="section">
    <div class="card-custom">
      <h5>Bitcoin <span class="muted">(BTC)</span></h5>
      <canvas id="bitcoinChart" style="max-height:250px;margin:16px 0;"></canvas>
      <div style="background:#f5f5f5;padding:12px;border-radius:8px;margin-bottom:16px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
          <span class="muted">Live Price (USD):</span><span id="bitcoinLivePrice" style="font-weight:600;"></span>
        </div>
        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
          <span class="muted">You Own:</span><span id="bitcoinHolding" style="font-weight:600;"></span>
        </div>
        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
          <span class="muted">Wallet Address:</span>
          <div style="display:flex;gap:6px;align-items:center;">
            <span id="bitcoinWallet" style="font-weight:600;font-size:12px;"></span>
            <i class="bi bi-clipboard copy-btn" id="copyBitcoinWallet" title="Copy wallet" style="cursor:pointer;color:var(--accent-4);"></i>
          </div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px;">
        <button id="buyCryptoFromDetail" class="btn btn-success" data-crypto="bitcoin">Buy</button>
        <button id="sendCryptoFromDetail" class="btn btn-primary" data-crypto="bitcoin">Send</button>
        <button id="sellCryptoFromDetail" class="btn btn-danger" data-crypto="bitcoin">Sell</button>
      </div>
      <div class="mt-2"><span class="link-like" id="bitcoinBack">← Back</span></div>
      <div id="bitcoinError" class="error mt-2" style="display:none"></div>
    </div>
  </div>

  <!-- ETHEREUM DETAIL -->
  <div id="ethereumDetailSection" class="section">
    <div class="card-custom">
      <h5>Ethereum <span class="muted">(ETH)</span></h5>
      <canvas id="ethereumChart" style="max-height:250px;margin:16px 0;"></canvas>
      <div style="background:#f5f5f5;padding:12px;border-radius:8px;margin-bottom:16px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
          <span class="muted">Live Price (USD):</span><span id="ethereumLivePrice" style="font-weight:600;"></span>
        </div>
        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
          <span class="muted">You Own:</span><span id="ethereumHolding" style="font-weight:600;"></span>
        </div>
        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
          <span class="muted">Wallet Address:</span>
          <div style="display:flex;gap:6px;align-items:center;">
            <span id="ethereumWallet" style="font-weight:600;font-size:12px;"></span>
            <i class="bi bi-clipboard copy-btn" id="copyEthereumWallet" title="Copy wallet" style="cursor:pointer;color:var(--accent-4);"></i>
          </div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px;">
        <button id="buyCryptoFromDetail2" class="btn btn-success" data-crypto="ethereum">Buy</button>
        <button id="sendCryptoFromDetail2" class="btn btn-primary" data-crypto="ethereum">Send</button>
        <button id="sellCryptoFromDetail2" class="btn btn-danger" data-crypto="ethereum">Sell</button>
      </div>
      <div class="mt-2"><span class="link-like" id="ethereumBack">← Back</span></div>
      <div id="ethereumError" class="error mt-2" style="display:none"></div>
    </div>
  </div>

  <!-- LITECOIN DETAIL -->
  <div id="litecoinDetailSection" class="section">
    <div class="card-custom">
      <h5>Litecoin <span class="muted">(LTC)</span></h5>
      <canvas id="litecoinChart" style="max-height:250px;margin:16px 0;"></canvas>
      <div style="background:#f5f5f5;padding:12px;border-radius:8px;margin-bottom:16px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
          <span class="muted">Live Price (USD):</span><span id="litecoinLivePrice" style="font-weight:600;"></span>
        </div>
        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
          <span class="muted">You Own:</span><span id="litecoinHolding" style="font-weight:600;"></span>
        </div>
        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
          <span class="muted">Wallet Address:</span>
          <div style="display:flex;gap:6px;align-items:center;">
            <span id="litecoinWallet" style="font-weight:600;font-size:12px;"></span>
            <i class="bi bi-clipboard copy-btn" id="copyLitecoinWallet" title="Copy wallet" style="cursor:pointer;color:var(--accent-4);"></i>
          </div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px;">
        <button id="buyCryptoFromDetail3" class="btn btn-success" data-crypto="litecoin">Buy</button>
        <button id="sendCryptoFromDetail3" class="btn btn-primary" data-crypto="litecoin">Send</button>
        <button id="sellCryptoFromDetail3" class="btn btn-danger" data-crypto="litecoin">Sell</button>
      </div>
      <div class="mt-2"><span class="link-like" id="litecoinBack">← Back</span></div>
      <div id="litecoinError" class="error mt-2" style="display:none"></div>
    </div>
  </div>

  <!-- SEND CRYPTO FROM DETAIL -->
  <div id="sendCryptoDetailSection" class="section">
    <div class="card-custom">
      <h5 id="sendCryptoTitle">Send Bitcoin</h5>
      <label>Recipient Wallet Address</label>
      <input id="sendCryptoRecipient" class="mb-2 form-control" placeholder="0x..."/>
      <div style="display:flex;gap:8px;margin-bottom:12px;">
        <button id="sendCryptoToggle" class="btn btn-sm btn-outline-secondary" style="flex:1;">Crypto Amount</button>
        <button id="sendCryptoToggleUSD" class="btn btn-sm btn-outline-secondary" style="flex:1;">USD Amount</button>
      </div>
      <label id="sendCryptoInputLabel">Amount (Crypto)</label>
      <div style="display:flex;gap:8px;margin-bottom:12px;">
        <input id="sendCryptoAmount" type="number" class="form-control" placeholder="0.00" step="0.0001" style="flex:1;"/>
        <button id="sendCryptoMax" class="btn btn-outline-secondary" style="min-width:50px;">Max</button>
      </div>
      <div style="background:#f5f5f5;padding:12px;border-radius:8px;margin-bottom:12px;">
        <div style="display:flex;justify-content:space-between;">
          <span class="muted" id="sendCryptoConvertLabel">USD Value:</span><span id="sendCryptoUsdValue" style="font-weight:600;">$0.00</span>
        </div>
      </div>
      <label>Enter PIN</label>
      <input id="sendCryptoPinDetail" type="password" class="mb-2 form-control" placeholder="PIN"/>
      <button id="sendCryptoSubmitDetail" class="btn btn-primary w-100">Send</button>
      <div class="mt-2"><span class="link-like" id="sendCryptoDetailBack">← Back</span></div>
      <div id="sendCryptoDetailError" class="error mt-2" style="display:none"></div>
    </div>
  </div>

  <!-- BUY CRYPTO FROM DETAIL -->
  <div id="buyCryptoDetailSection" class="section">
    <div class="card-custom">
      <h5 id="buyCryptoTitle">Buy Bitcoin</h5>
      <div style="display:flex;gap:8px;margin-bottom:12px;">
        <button id="buyCryptoToggle" class="btn btn-sm btn-outline-secondary" style="flex:1;">USD Amount</button>
        <button id="buyCryptoToggleCrypto" class="btn btn-sm btn-outline-secondary" style="flex:1;">Crypto Amount</button>
      </div>
      <label id="buyCryptoInputLabel">Amount (USD)</label>
      <div style="display:flex;gap:8px;margin-bottom:12px;">
        <input id="buyCryptoAmount" type="number" class="form-control" placeholder="0.00" style="flex:1;"/>
        <button id="buyCryptoMax" class="btn btn-outline-secondary" style="min-width:50px;">Max</button>
      </div>
      <div style="background:#f5f5f5;padding:12px;border-radius:8px;margin-bottom:12px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
          <span class="muted" id="buyCryptoConvertLabel">You Will Get:</span><span id="buyCryptoCryptoAmount" style="font-weight:600;">0 BTC</span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span class="muted">Fee (2%):</span><span id="buyCryptoFee" style="font-weight:600;">$0.00</span>
        </div>
      </div>
      <label>Enter PIN</label>
      <input id="buyCryptoPinDetail" type="password" class="mb-2 form-control" placeholder="PIN"/>
      <button id="buyCryptoSubmitDetail" class="btn btn-success w-100">Buy</button>
      <div class="mt-2"><span class="link-like" id="buyCryptoDetailBack">← Back</span></div>
      <div id="buyCryptoDetailError" class="error mt-2" style="display:none"></div>
    </div>
  </div>

  <!-- SELL CRYPTO FROM DETAIL -->
  <div id="sellCryptoDetailSection" class="section">
    <div class="card-custom">
      <h5 id="sellCryptoTitle">Sell Bitcoin</h5>
      <div style="display:flex;gap:8px;margin-bottom:12px;">
        <button id="sellCryptoToggle" class="btn btn-sm btn-outline-secondary" style="flex:1;">Crypto Amount</button>
        <button id="sellCryptoToggleUSD" class="btn btn-sm btn-outline-secondary" style="flex:1;">USD Amount</button>
      </div>
      <label id="sellCryptoInputLabel">Amount (Crypto)</label>
      <div style="display:flex;gap:8px;margin-bottom:12px;">
        <input id="sellCryptoAmount" type="number" class="form-control" placeholder="0.00" step="0.0001" style="flex:1;"/>
        <button id="sellCryptoMax" class="btn btn-outline-secondary" style="min-width:50px;">Max</button>
      </div>
      <div style="background:#f5f5f5;padding:12px;border-radius:8px;margin-bottom:12px;">
        <div style="display:flex;justify-content:space-between;">
          <span class="muted" id="sellCryptoConvertLabel">USD You Will Get:</span><span id="sellCryptoUsdAmount" style="font-weight:600;">$0.00</span>
        </div>
      </div>
      <label>Enter PIN</label>
      <input id="sellCryptoPinDetail" type="password" class="mb-2 form-control" placeholder="PIN"/>
      <button id="sellCryptoSubmitDetail" class="btn btn-danger w-100">Sell</button>
      <div class="mt-2"><span class="link-like" id="sellCryptoDetailBack">← Back</span></div>
      <div id="sellCryptoDetailError" class="error mt-2" style="display:none"></div>
    </div>
  </div>

  <!-- PROFILE -->
  <div id="profileSection" class="section">
    <div class="card-custom">
      <h5>Profile Settings</h5>
      <div style="text-align:center;margin-bottom:16px">
        <img id="profilePic" src="" style="width:100px;height:100px;border-radius:50px;object-fit:cover;margin-bottom:12px;">
      </div>
      <label>Upload Photo</label>
      <input id="uploadProfile" type="file" accept="image/*" class="mb-2 form-control"/>
      <label>Full Name</label>
      <input id="profileName" class="mb-2 form-control" placeholder="Your name"/>
      <label>Email</label>
      <input id="profileEmail" class="mb-2 form-control" disabled/>
      <label>Change Transaction PIN (leave blank to keep)</label>
      <input id="profileNewPin" type="password" class="mb-2 form-control" placeholder="New PIN (4+ digits)"/>
      <label>Your Crypto Wallet Address</label>
      <div style="display:flex;gap:8px;">
        <input id="profileWallet" class="mb-2 form-control" disabled style="background:#f5f5f5;"/>
        <button id="copyWalletBtn" class="btn btn-primary" style="padding:10px 14px;min-width:50px;">Copy</button>
      </div>
      <button id="saveProfileBtn" class="btn btn-primary w-100">Save Changes</button>
      <div id="profileMsg" class="mt-2" style="display:none;color:green;text-align:center;font-weight:600"></div>
      <div class="mt-2"><span class="link-like" id="profileBack">← Back to Dashboard</span></div>
    </div>
  </div>

  <!-- SEND -->
  <div id="sendSection" class="section">
    <div class="card-custom">
      <h5>Send Money</h5>
      <label>To account</label>
      <input id="sendTo" class="mb-2 form-control" placeholder="Account number"/>
      <label>Amount (USD)</label>
      <input id="sendAmount" type="number" class="mb-2 form-control" placeholder="0.00"/>
      <label>Enter PIN</label>
      <input id="sendPin" type="password" class="mb-2 form-control" placeholder="PIN"/>
      <button id="sendSubmit" class="btn btn-primary w-100">Send</button>
      <div class="mt-2"><span class="link-like" id="sendBack">← Back</span></div>
      <div id="sendError" class="error mt-2" style="display:none"></div>
    </div>
  </div>

  <!-- TOPUP -->
  <div id="topupSection" class="section">
    <div class="card-custom">
      <h5>Top Up</h5>
      <label>Amount (USD)</label>
      <input id="topupAmount" type="number" class="mb-2 form-control" placeholder="0.00"/>
      <label>Enter PIN</label>
      <input id="topupPin" type="password" class="mb-2 form-control" placeholder="PIN"/>
      <button id="topupSubmit" class="btn btn-success w-100">Top Up</button>
      <div class="mt-2"><span class="link-like" id="topupBack">← Back</span></div>
      <div id="topupError" class="error mt-2" style="display:none"></div>
    </div>
  </div>

  <!-- WITHDRAW -->
  <div id="withdrawSection" class="section">
    <div class="card-custom">
      <h5>Withdraw</h5>
      <label>Amount (USD)</label>
      <input id="withdrawAmount" type="number" class="mb-2 form-control" placeholder="0.00"/>
      <label>Enter PIN</label>
      <input id="withdrawPin" type="password" class="mb-2 form-control" placeholder="PIN"/>
      <button id="withdrawSubmit" class="btn btn-danger w-100">Withdraw</button>
      <div class="mt-2"><span class="link-like" id="withdrawBack">← Back</span></div>
      <div id="withdrawError" class="error mt-2" style="display:none"></div>
    </div>
  </div>

  <!-- WIRE -->
  <div id="wireSection" class="section">
    <div class="card-custom">
      <h5>Wire Transfer</h5>
      <label>Country</label>
      <select id="wireCountry" class="mb-2 form-control">
        <option>USA</option><option>UK</option><option>Canada</option>
      </select>
      <label>Bank</label>
      <input id="wireBank" class="mb-2 form-control" placeholder="Bank name"/>
      <label>Recipient</label>
      <input id="wireName" class="mb-2 form-control" placeholder="Name"/>
      <label>Account</label>
      <input id="wireAcc" class="mb-2 form-control" placeholder="Account"/>
      <label>Amount (USD)</label>
      <input id="wireAmount" type="number" class="mb-2 form-control" placeholder="0.00"/>
      <p class="muted">Fee (5%): $<span id="wireFee">0.00</span> | Total: $<span id="wireTotal">0.00</span></p>
      <label>Enter PIN</label>
      <input id="wirePin" type="password" class="mb-2 form-control" placeholder="PIN"/>
      <button id="wireSubmit" class="btn btn-primary w-100">Send Wire</button>
      <div class="mt-2"><span class="link-like" id="wireBack">← Back</span></div>
      <div id="wireError" class="error mt-2" style="display:none"></div>
    </div>
  </div>

  <!-- CRYPTO PRICES & CHART -->
  <div id="cryptoPricesModal" style="display:none; position:fixed; left:0; right:0; top:0; bottom:0; background:rgba(0,0,0,.5); z-index:50; justify-content:center; align-items:center; overflow-y:auto; padding:20px 0;">
    <div style="background:#fff;border-radius:12px;max-width:600px;width:92%;margin:auto;padding:20px;">
      <h3 style="margin-bottom:20px;font-weight:700;">Crypto Market Prices</h3>
      <div id="pricesList" style="max-height:300px;overflow-y:auto;margin-bottom:20px;">
        <p class="muted text-center">Loading prices...</p>
      </div>
      <canvas id="priceChart" style="max-height:300px;margin-bottom:20px;"></canvas>
      <button id="closePricesBtn" class="btn btn-primary w-100">Close</button>
    </div>
  </div>

  <!-- CRYPTO CONFIRMATION -->
  <div id="cryptoConfirmModal" style="display:none; position:fixed; left:0; right:0; top:0; bottom:0; background:rgba(0,0,0,.5); z-index:45; justify-content:center; align-items:center;">
    <div style="background:#fff;padding:20px;border-radius:12px;max-width:520px;width:92%;">
      <h4 style="text-align:center;margin-bottom:20px;font-weight:700;">Confirm Crypto Transfer</h4>
      <div style="background:#f5f5f5;padding:16px;border-radius:8px;margin-bottom:20px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:12px;">
          <span class="muted">Amount:</span>
          <span id="confirmAmount" style="font-weight:600;"></span>
        </div>
        <div style="display:flex;justify-content:space-between;margin-bottom:12px;">
          <span class="muted">Crypto Type:</span>
          <span id="confirmCrypto" style="font-weight:600;"></span>
        </div>
        <div style="display:flex;justify-content:space-between;margin-bottom:12px;">
          <span class="muted">From Wallet:</span>
          <span id="confirmFrom" style="font-weight:600;font-size:12px;"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span class="muted">To Wallet:</span>
          <span id="confirmTo" style="font-weight:600;font-size:12px;"></span>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <button id="cancelCryptoConfirm" class="btn btn-danger">Cancel</button>
        <button id="confirmCryptoTransfer" class="btn btn-primary">Confirm</button>
      </div>
    </div>
  </div>

  <!-- RECEIPT -->
  <div id="receiptModal" style="display:none; position:fixed; left:0; right:0; top:0; bottom:0; background:rgba(0,0,0,.5); z-index:40; justify-content:center; align-items:center;">
    <div style="background:#fff;padding:20px;border-radius:12px;max-width:520px;width:92%;">
      <div style="text-align:center;font-size:28px;margin-bottom:6px;">✅</div>
      <h4 id="receiptTitle" style="text-align:center;margin-bottom:6px;">Success</h4>
      <div id="receiptBody" style="font-size:15px;line-height:1.6;color:#222;"></div>
      <button id="closeReceiptBtn" class="btn btn-primary w-100 mt-3">Back</button>
    </div>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, serverTimestamp, query, where, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAjy5sgZPMFsklKkSOMyC1HCvQ4-qNKP-M",
    authDomain: "fir-bank-c659f.firebaseapp.com",
    projectId: "fir-bank-c659f",
    storageBucket: "fir-bank-c659f.firebasestorage.app",
    messagingSenderId: "847611883266",
    appId: "1:847611883266:web:651ecee5dfea8e0f1cdc1b",
    measurementId: "G-QK7R83FC51"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  function genAccountNumber(){ return String(Math.floor(1000000000 + Math.random()*9000000000)); }
  function maskAcc(a){ if(!a) return ""; return a.slice(0,4) + " **** " + a.slice(-4); }
  function genTxID(){ return "TX-"+Math.floor(100000000 + Math.random()*900000000); }
  function genWalletAddress(){ return "0x" + Array.from({length:40}, ()=>Math.floor(Math.random()*16).toString(16)).join(""); }
  function showSection(id){
    document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    document.getElementById("bottomNav").style.display = (id==="dashboardSection") ? "flex" : "none";
    closeMenu();
    window.scrollTo(0,0);
  }
  function showError(elId,msg){ 
    const e=document.getElementById(elId); 
    if(!e) return;
    e.innerText=msg; 
    e.style.display = msg? "block":"none"; 
  }
  function openMenu(){
    document.getElementById("menuOverlay").classList.add("open");
    document.getElementById("menuPanel").classList.add("open");
  }
  function closeMenu(){
    document.getElementById("menuOverlay").classList.remove("open");
    document.getElementById("menuPanel").classList.remove("open");
  }

  let currentUser = null;

  onAuthStateChanged(auth, async (u)=>{
    if(u){
      const userDocRef = doc(db,"users",u.uid);
      const snap = await getDoc(userDocRef);
      if(!snap.exists()){
        await setDoc(userDocRef,{
          name: u.email.split("@")[0],
          email: u.email,
          checkingBalance: 5000,
          savingsBalance: 3000,
          checkingAcc: genAccountNumber(),
          savingsAcc: genAccountNumber(),
          walletAddress: genWalletAddress(),
          cryptoWallets: {
            bitcoin: genWalletAddress(),
            ethereum: genWalletAddress(),
            litecoin: genWalletAddress()
          },
          transactionPin: "",
          profilePic: "",
          cryptoHoldings: {
            bitcoin: 0,
            ethereum: 0,
            litecoin: 0
          }
        });
      }
      await loadDashboardUI();
      showSection("dashboardSection");
    } else {
      currentUser = null;
      showSection("authSection");
    }
  });

  document.getElementById("showLogin").onclick = ()=>{ 
    document.getElementById("loginBox").style.display="block"; 
    document.getElementById("signupBox").style.display="none"; 
  };
  document.getElementById("showSignup").onclick = ()=>{ 
    document.getElementById("signupBox").style.display="block"; 
    document.getElementById("loginBox").style.display="none"; 
  };

  // MENU
  document.getElementById("menuToggle").addEventListener("click", openMenu);
  document.getElementById("menuOverlay").addEventListener("click", closeMenu);
  document.getElementById("transactionsMenuItem").addEventListener("click", ()=> loadTransactionsView(null));
  document.getElementById("cryptoMenuItem").addEventListener("click", ()=> showSection("cryptoListSection"));
  document.getElementById("profileMenuItem").addEventListener("click", ()=> showSection("profileSection"));
  document.getElementById("logoutMenuItem").addEventListener("click", async ()=> { await signOut(auth); });
  document.getElementById("transactionsBack").addEventListener("click", ()=> showSection("dashboardSection"));
  document.getElementById("cryptoBtn").addEventListener("click", ()=> loadCryptoListPage());
  document.getElementById("checkingCard").addEventListener("click", ()=> loadTransactionsView("checking"));
  document.getElementById("savingsCard").addEventListener("click", ()=> loadTransactionsView("savings"));
  document.getElementById("closePricesBtn").addEventListener("click", ()=> document.getElementById("cryptoPricesModal").style.display="none");
  document.getElementById("copyWalletBtn").addEventListener("click", ()=> {
    const wallet = document.getElementById("profileWallet").value;
    if(wallet) navigator.clipboard.writeText(wallet);
  });
  
  document.getElementById("bitcoinCard").addEventListener("click", ()=> loadCryptoDetail("bitcoin"));
  document.getElementById("ethereumCard").addEventListener("click", ()=> loadCryptoDetail("ethereum"));
  document.getElementById("litecoinCard").addEventListener("click", ()=> loadCryptoDetail("litecoin"));
  document.getElementById("cryptoListBack").addEventListener("click", ()=> showSection("dashboardSection"));
  document.getElementById("bitcoinBack").addEventListener("click", ()=> showSection("cryptoListSection"));
  document.getElementById("ethereumBack").addEventListener("click", ()=> showSection("cryptoListSection"));
  document.getElementById("litecoinBack").addEventListener("click", ()=> showSection("cryptoListSection"));
  
  document.getElementById("copyBitcoinWallet").addEventListener("click", ()=> navigator.clipboard.writeText(cryptoWallets.bitcoin || ""));
  document.getElementById("copyEthereumWallet").addEventListener("click", ()=> navigator.clipboard.writeText(cryptoWallets.ethereum || ""));
  document.getElementById("copyLitecoinWallet").addEventListener("click", ()=> navigator.clipboard.writeText(cryptoWallets.litecoin || ""));
  
  let currentCryptoAction = null;
  let sendCryptoMode = "crypto";
  let buyCryptoMode = "usd";
  let sellCryptoMode = "crypto";
  function openSendCryptoPage(cryptoType){
    currentCryptoAction = {type: "send", crypto: cryptoType};
    const symbol = {bitcoin: "BTC", ethereum: "ETH", litecoin: "LTC"}[cryptoType];
    document.getElementById("sendCryptoTitle").innerText = "Send "+cryptoType.charAt(0).toUpperCase() + cryptoType.slice(1);
    document.getElementById("sendCryptoAmount").value="";
    document.getElementById("sendCryptoRecipient").value="";
    document.getElementById("sendCryptoPinDetail").value="";
    document.getElementById("sendCryptoDetailError").innerText="";
    showSection("sendCryptoDetailSection");
  }
  
  function openBuyCryptoPage(cryptoType){
    currentCryptoAction = {type: "buy", crypto: cryptoType};
    const symbol = {bitcoin: "BTC", ethereum: "ETH", litecoin: "LTC"}[cryptoType];
    document.getElementById("buyCryptoTitle").innerText = "Buy "+cryptoType.charAt(0).toUpperCase() + cryptoType.slice(1);
    document.getElementById("buyCryptoAmount").value="";
    document.getElementById("buyCryptoPinDetail").value="";
    document.getElementById("buyCryptoDetailError").innerText="";
    showSection("buyCryptoDetailSection");
  }
  
  function openSellCryptoPage(cryptoType){
    currentCryptoAction = {type: "sell", crypto: cryptoType};
    const symbol = {bitcoin: "BTC", ethereum: "ETH", litecoin: "LTC"}[cryptoType];
    document.getElementById("sellCryptoTitle").innerText = "Sell "+cryptoType.charAt(0).toUpperCase() + cryptoType.slice(1);
    document.getElementById("sellCryptoAmount").value="";
    document.getElementById("sellCryptoPinDetail").value="";
    document.getElementById("sellCryptoDetailError").innerText="";
    showSection("sellCryptoDetailSection");
  }
  
  document.getElementById("buyCryptoFromDetail").addEventListener("click", ()=> openBuyCryptoPage("bitcoin"));
  document.getElementById("sendCryptoFromDetail").addEventListener("click", ()=> openSendCryptoPage("bitcoin"));
  document.getElementById("sellCryptoFromDetail").addEventListener("click", ()=> openSellCryptoPage("bitcoin"));
  
  document.getElementById("buyCryptoFromDetail2").addEventListener("click", ()=> openBuyCryptoPage("ethereum"));
  document.getElementById("sendCryptoFromDetail2").addEventListener("click", ()=> openSendCryptoPage("ethereum"));
  document.getElementById("sellCryptoFromDetail2").addEventListener("click", ()=> openSellCryptoPage("ethereum"));
  
  document.getElementById("buyCryptoFromDetail3").addEventListener("click", ()=> openBuyCryptoPage("litecoin"));
  document.getElementById("sendCryptoFromDetail3").addEventListener("click", ()=> openSendCryptoPage("litecoin"));
  document.getElementById("sellCryptoFromDetail3").addEventListener("click", ()=> openSellCryptoPage("litecoin"));
  
  document.getElementById("sendCryptoDetailBack").addEventListener("click", ()=> {
    const section = currentCryptoAction?.crypto === "bitcoin" ? "bitcoinDetailSection" : 
                   currentCryptoAction?.crypto === "ethereum" ? "ethereumDetailSection" : "litecoinDetailSection";
    showSection(section);
  });
  
  document.getElementById("buyCryptoDetailBack").addEventListener("click", ()=> {
    const section = currentCryptoAction?.crypto === "bitcoin" ? "bitcoinDetailSection" : 
                   currentCryptoAction?.crypto === "ethereum" ? "ethereumDetailSection" : "litecoinDetailSection";
    showSection(section);
  });
  
  document.getElementById("sellCryptoDetailBack").addEventListener("click", ()=> {
    const section = currentCryptoAction?.crypto === "bitcoin" ? "bitcoinDetailSection" : 
                   currentCryptoAction?.crypto === "ethereum" ? "ethereumDetailSection" : "litecoinDetailSection";
    showSection(section);
  });
  
  document.getElementById("sendCryptoAmount").addEventListener("input", ()=> {
    if(!currentCryptoAction) return;
    const amt = parseFloat(document.getElementById("sendCryptoAmount").value) || 0;
    const price = cryptoPrices[currentCryptoAction.crypto]?.usd || 0;
    document.getElementById("sendCryptoUsdValue").innerText = "$" + (amt * price).toFixed(2);
  });
  
  document.getElementById("buyCryptoAmount").addEventListener("input", ()=> {
    if(!currentCryptoAction) return;
    const usdAmt = parseFloat(document.getElementById("buyCryptoAmount").value) || 0;
    const price = cryptoPrices[currentCryptoAction.crypto]?.usd || 1;
    const cryptoAmt = (usdAmt / price).toFixed(4);
    const symbol = {bitcoin: "BTC", ethereum: "ETH", litecoin: "LTC"}[currentCryptoAction.crypto];
    const fee = (usdAmt * 0.02).toFixed(2);
    document.getElementById("buyCryptoCryptoAmount").innerText = cryptoAmt + " " + symbol;
    document.getElementById("buyCryptoFee").innerText = "$" + fee;
  });
  
  document.getElementById("sellCryptoAmount").addEventListener("input", ()=> {
    if(!currentCryptoAction) return;
    const cryptoAmt = parseFloat(document.getElementById("sellCryptoAmount").value) || 0;
    const price = cryptoPrices[currentCryptoAction.crypto]?.usd || 0;
    document.getElementById("sellCryptoUsdAmount").innerText = "$" + (cryptoAmt * price).toFixed(2);
  });
  
  document.getElementById("sendCryptoSubmitDetail").addEventListener("click", async ()=> {
    try{
      if(!currentCryptoAction || currentCryptoAction.type !== "send") return;
      showError("sendCryptoDetailError", "");
      const cryptoType = currentCryptoAction.crypto;
      const cryptoKey = cryptoType;
      const toWallet = document.getElementById("sendCryptoRecipient").value.trim();
      const amt = parseFloat(document.getElementById("sendCryptoAmount").value);
      const pin = document.getElementById("sendCryptoPinDetail").value.trim();
      
      if(!toWallet || !amt || amt <= 0 || isNaN(amt)) { showError("sendCryptoDetailError", "Fill all fields"); return; }
      if(!toWallet.startsWith("0x")) { showError("sendCryptoDetailError", "Invalid wallet"); return; }
      
      const uid = auth.currentUser.uid;
      const snap = await getDoc(doc(db,"users",uid));
      const udata = snap.data();
      if(udata.transactionPin !== pin){ showError("sendCryptoDetailError", "Wrong PIN"); return; }
      if((udata.cryptoHoldings[cryptoKey] || 0) < amt){ showError("sendCryptoDetailError", "Insufficient"); return; }
      
      const q = query(collection(db,"users"), where("cryptoWallets."+cryptoKey, "==", toWallet));
      const recipSnap = await getDocs(q);
      if(recipSnap.empty){ showError("sendCryptoDetailError", "Wallet not found"); return; }
      
      const recipientUid = recipSnap.docs[0].id;
      const txid = genTxID();
      const senderRef = doc(db,"users",uid);
      const recipientRef = doc(db,"users",recipientUid);
      
      await runTransaction(db, async (transaction) => {
        const senderDoc = await transaction.get(senderRef);
        const recipientDoc = await transaction.get(recipientRef);
        const senderData = senderDoc.data();
        if((senderData.cryptoHoldings[cryptoKey] || 0) < amt) throw new Error("Insufficient");
        transaction.update(senderRef, {
          cryptoHoldings: {
            ...senderData.cryptoHoldings,
            [cryptoKey]: (senderData.cryptoHoldings[cryptoKey] || 0) - amt
          }
        });
        const recData = recipientDoc.data();
        transaction.update(recipientRef, {
          cryptoHoldings: {
            ...recData.cryptoHoldings,
            [cryptoKey]: (recData.cryptoHoldings[cryptoKey] || 0) + amt
          }
        });
      });
      
      await recordTransaction(uid, {type: "Send Crypto", amount: amt, fee: 0, total: amt, from: cryptoWallets[cryptoKey], to: toWallet, status: "Success", txid});
      await recordTransaction(recipientUid, {type: "Received Crypto", amount: amt, fee: 0, total: amt, from: cryptoWallets[cryptoKey], to: toWallet, status: "Success", txid});
      
      await loadDashboardUI();
      showReceipt({type: "Send "+cryptoType, amount: amt, from: cryptoWallets[cryptoKey], to: toWallet, txid});
    }catch(e){ showError("sendCryptoDetailError", e.message); }
  });
  
  document.getElementById("buyCryptoSubmitDetail").addEventListener("click", async ()=> {
    try{
      if(!currentCryptoAction || currentCryptoAction.type !== "buy") return;
      showError("buyCryptoDetailError", "");
      const cryptoType = currentCryptoAction.crypto;
      const cryptoKey = cryptoType;
      const usdAmt = parseFloat(document.getElementById("buyCryptoAmount").value);
      const pin = document.getElementById("buyCryptoPinDetail").value.trim();
      
      if(!usdAmt || usdAmt <= 0 || isNaN(usdAmt)) { showError("buyCryptoDetailError", "Enter amount"); return; }
      
      const uid = auth.currentUser.uid;
      const snap = await getDoc(doc(db,"users",uid));
      const udata = snap.data();
      if(udata.transactionPin !== pin){ showError("buyCryptoDetailError", "Wrong PIN"); return; }
      
      const fee = (usdAmt * 0.02).toFixed(2);
      const total = parseFloat(usdAmt) + parseFloat(fee);
      if((udata.checkingBalance || 0) < total){ showError("buyCryptoDetailError", "Insufficient USD"); return; }
      
      const price = cryptoPrices[cryptoKey]?.usd || 1;
      const cryptoAmt = (usdAmt / price);
      const txid = genTxID();
      
      await runTransaction(db, async (transaction) => {
        const userDoc = await transaction.get(doc(db,"users",uid));
        const userData = userDoc.data();
        if((userData.checkingBalance || 0) < total) throw new Error("Insufficient");
        transaction.update(doc(db,"users",uid), {
          checkingBalance: (userData.checkingBalance || 0) - total,
          cryptoHoldings: {
            ...userData.cryptoHoldings,
            [cryptoKey]: (userData.cryptoHoldings[cryptoKey] || 0) + cryptoAmt
          }
        });
      });
      
      await recordTransaction(uid, {type: "Buy Crypto", amount: usdAmt, fee: parseFloat(fee), total, from: udata.checkingAcc, to: cryptoType, status: "Success", txid});
      await loadDashboardUI();
      showReceipt({type: "Buy "+cryptoType, amount: cryptoAmt.toFixed(4), fee: parseFloat(fee), txid});
    }catch(e){ showError("buyCryptoDetailError", e.message); }
  });
  
  document.getElementById("sellCryptoSubmitDetail").addEventListener("click", async ()=> {
    try{
      if(!currentCryptoAction || currentCryptoAction.type !== "sell") return;
      showError("sellCryptoDetailError", "");
      const cryptoType = currentCryptoAction.crypto;
      const cryptoKey = cryptoType;
      const cryptoAmt = parseFloat(document.getElementById("sellCryptoAmount").value);
      const pin = document.getElementById("sellCryptoPinDetail").value.trim();
      
      if(!cryptoAmt || cryptoAmt <= 0 || isNaN(cryptoAmt)) { showError("sellCryptoDetailError", "Enter amount"); return; }
      
      const uid = auth.currentUser.uid;
      const snap = await getDoc(doc(db,"users",uid));
      const udata = snap.data();
      if(udata.transactionPin !== pin){ showError("sellCryptoDetailError", "Wrong PIN"); return; }
      if((udata.cryptoHoldings[cryptoKey] || 0) < cryptoAmt){ showError("sellCryptoDetailError", "Insufficient"); return; }
      
      const price = cryptoPrices[cryptoKey]?.usd || 0;
      const usdAmt = (cryptoAmt * price);
      const txid = genTxID();
      
      await runTransaction(db, async (transaction) => {
        const userDoc = await transaction.get(doc(db,"users",uid));
        const userData = userDoc.data();
        if((userData.cryptoHoldings[cryptoKey] || 0) < cryptoAmt) throw new Error("Insufficient");
        transaction.update(doc(db,"users",uid), {
          checkingBalance: (userData.checkingBalance || 0) + usdAmt,
          cryptoHoldings: {
            ...userData.cryptoHoldings,
            [cryptoKey]: (userData.cryptoHoldings[cryptoKey] || 0) - cryptoAmt
          }
        });
      });
      
      await recordTransaction(uid, {type: "Sell Crypto", amount: cryptoAmt, fee: 0, total: usdAmt, from: cryptoType, to: udata.checkingAcc, status: "Success", txid});
      await loadDashboardUI();
      showReceipt({type: "Sell "+cryptoType, amount: usdAmt.toFixed(2), txid});
    }catch(e){ showError("sellCryptoDetailError", e.message); }
  });
  
  // Wallet copy buttons
  document.getElementById("copyBitcoinWallet").addEventListener("click", ()=> {
    const wallet = document.getElementById("bitcoinWallet").innerText.split("...")[0] + cryptoWallets.bitcoin.slice(-8);
    navigator.clipboard.writeText(cryptoWallets.bitcoin);
  });
  document.getElementById("copyEthereumWallet").addEventListener("click", ()=> {
    navigator.clipboard.writeText(cryptoWallets.ethereum);
  });
  document.getElementById("copyLitecoinWallet").addEventListener("click", ()=> {
    navigator.clipboard.writeText(cryptoWallets.litecoin);
  });
  
  // Buy/Send/Sell handlers
  let currentCryptoDetail = null;
  
  const buyBtns = [document.getElementById("buyCryptoFromDetail"), document.getElementById("buyCryptoFromDetail2"), document.getElementById("buyCryptoFromDetail3")];
  buyBtns.forEach(btn=> btn.addEventListener("click", ()=>{
    currentCryptoDetail = btn.dataset.crypto;
    const crypto = currentCryptoDetail;
    const symbol = {bitcoin: "BTC", ethereum: "ETH", litecoin: "LTC"}[crypto];
    document.getElementById("buyCryptoTitle").innerText = "Buy "+crypto.charAt(0).toUpperCase()+crypto.slice(1);
    document.getElementById("buyCryptoAmount").value = "";
    document.getElementById("buyCryptoPinDetail").value = "";
    showError("buyCryptoDetailError", "");
    showSection("buyCryptoDetailSection");
  }));
  
  const sendBtns = [document.getElementById("sendCryptoFromDetail"), document.getElementById("sendCryptoFromDetail2"), document.getElementById("sendCryptoFromDetail3")];
  sendBtns.forEach(btn=> btn.addEventListener("click", ()=>{
    currentCryptoDetail = btn.dataset.crypto;
    const crypto = currentCryptoDetail;
    const symbol = {bitcoin: "BTC", ethereum: "ETH", litecoin: "LTC"}[crypto];
    document.getElementById("sendCryptoTitle").innerText = "Send "+crypto.charAt(0).toUpperCase()+crypto.slice(1);
    document.getElementById("sendCryptoRecipient").value = "";
    document.getElementById("sendCryptoAmount").value = "";
    document.getElementById("sendCryptoPinDetail").value = "";
    showError("sendCryptoDetailError", "");
    showSection("sendCryptoDetailSection");
  }));
  
  const sellBtns = [document.getElementById("sellCryptoFromDetail"), document.getElementById("sellCryptoFromDetail2"), document.getElementById("sellCryptoFromDetail3")];
  sellBtns.forEach(btn=> btn.addEventListener("click", ()=>{
    currentCryptoDetail = btn.dataset.crypto;
    const crypto = currentCryptoDetail;
    document.getElementById("sellCryptoTitle").innerText = "Sell "+crypto.charAt(0).toUpperCase()+crypto.slice(1);
    document.getElementById("sellCryptoAmount").value = "";
    document.getElementById("sellCryptoPinDetail").value = "";
    showError("sellCryptoDetailError", "");
    showSection("sellCryptoDetailSection");
  }));
  
  // Back buttons
  document.getElementById("buyCryptoDetailBack").addEventListener("click", ()=> loadCryptoDetail(currentCryptoDetail));
  document.getElementById("sendCryptoDetailBack").addEventListener("click", ()=> loadCryptoDetail(currentCryptoDetail));
  document.getElementById("sellCryptoDetailBack").addEventListener("click", ()=> loadCryptoDetail(currentCryptoDetail));
  
  // Conversions
  document.getElementById("buyCryptoAmount").addEventListener("input", ()=>{
    const amt = parseFloat(document.getElementById("buyCryptoAmount").value) || 0;
    const price = cryptoPrices[currentCryptoDetail]?.usd || 0;
    const cryptoAmt = price > 0 ? (amt / price).toFixed(4) : 0;
    const fee = (amt * 0.02).toFixed(2);
    const symbol = {bitcoin: "BTC", ethereum: "ETH", litecoin: "LTC"}[currentCryptoDetail];
    document.getElementById("buyCryptoCryptoAmount").innerText = cryptoAmt + " " + symbol;
    document.getElementById("buyCryptoFee").innerText = "$" + fee;
  });
  
  document.getElementById("sendCryptoAmount").addEventListener("input", ()=>{
    const amt = parseFloat(document.getElementById("sendCryptoAmount").value) || 0;
    const price = cryptoPrices[currentCryptoDetail]?.usd || 0;
    const usdValue = (amt * price).toFixed(2);
    document.getElementById("sendCryptoUsdValue").innerText = "$" + usdValue;
  });
  
  document.getElementById("sellCryptoAmount").addEventListener("input", ()=>{
    const amt = parseFloat(document.getElementById("sellCryptoAmount").value) || 0;
    const price = cryptoPrices[currentCryptoDetail]?.usd || 0;
    const usdValue = (amt * price).toFixed(2);
    document.getElementById("sellCryptoUsdAmount").innerText = "$" + usdValue;
  });

  let priceChart = null;
  let cryptoPrices = {};
  let cryptoWallets = {bitcoin: "", ethereum: "", litecoin: ""};
  
  async function loadCryptoListPage(){
    try{
      const res = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,litecoin&vs_currencies=usd&include_24hr_change=true");
      cryptoPrices = await res.json();
      
      document.getElementById("btcPrice").innerText = "$"+cryptoPrices.bitcoin.usd.toFixed(2);
      document.getElementById("ethPrice").innerText = "$"+cryptoPrices.ethereum.usd.toFixed(2);
      document.getElementById("ltcPrice").innerText = "$"+cryptoPrices.litecoin.usd.toFixed(2);
      document.getElementById("btcChange").innerText = (cryptoPrices.bitcoin.usd_24h_change || 0).toFixed(2)+"%";
      document.getElementById("ethChange").innerText = (cryptoPrices.ethereum.usd_24h_change || 0).toFixed(2)+"%";
      document.getElementById("ltcChange").innerText = (cryptoPrices.litecoin.usd_24h_change || 0).toFixed(2)+"%";
      
      if(!currentUser.cryptoWallets) currentUser.cryptoWallets = {bitcoin: genWalletAddress(), ethereum: genWalletAddress(), litecoin: genWalletAddress()};
      cryptoWallets = currentUser.cryptoWallets || {bitcoin: genWalletAddress(), ethereum: genWalletAddress(), litecoin: genWalletAddress()};
      
      showSection("cryptoListSection");
    }catch(e){ console.error(e); }
  }
  
  async function loadCryptoDetail(cryptoType){
    try{
      const cryptoKey = cryptoType === "bitcoin" ? "bitcoin" : cryptoType === "ethereum" ? "ethereum" : "litecoin";
      const symbol = {bitcoin: "BTC", ethereum: "ETH", litecoin: "LTC"}[cryptoKey];
      const holding = (currentUser.cryptoHoldings || {})[cryptoKey] || 0;
      const wallet = cryptoWallets[cryptoKey] || genWalletAddress();
      const price = cryptoPrices[cryptoKey]?.usd || 0;
      
      document.getElementById(cryptoKey+"LivePrice").innerText = "$"+price.toFixed(2);
      document.getElementById(cryptoKey+"Holding").innerText = holding.toFixed(4)+" "+symbol;
      document.getElementById(cryptoKey+"Wallet").innerText = wallet.slice(0,10)+"..."+wallet.slice(-8);
      
      if(cryptoType === "bitcoin") showSection("bitcoinDetailSection");
      else if(cryptoType === "ethereum") showSection("ethereumDetailSection");
      else showSection("litecoinDetailSection");
      
      await loadCryptoChart(cryptoType);
    }catch(e){ console.error(e); }
  }
  
  let charts = {};
  async function loadCryptoChart(cryptoType){
    try{
      const id = cryptoType;
      const res = await fetch(`https://api.coingecko.com/api/v3/coins/${id}/market_chart?vs_currency=usd&days=7`);
      const data = await res.json();
      const prices = data.prices.map(p => p[1]);
      
      const ctx = document.getElementById(cryptoType+"Chart");
      if(charts[cryptoType]) charts[cryptoType].destroy();
      charts[cryptoType] = new Chart(ctx, {
        type: "line", data: {labels: Array(prices.length).fill(""), datasets: [{label: "Price (USD)", data: prices, borderColor: "var(--accent-1)", fill: false}]},
        options: {responsive: true, maintainAspectRatio: true, plugins: {legend: {display: false}}, scales: {y: {beginAtZero: false}}}
      });
    }catch(e){ console.error(e); }
  }

  let priceChartModal = null;
  async function loadCryptoPrices(){
    try{
      document.getElementById("cryptoPricesModal").style.display = "flex";
      document.getElementById("pricesList").innerHTML = "<p class='muted text-center'>Loading prices...</p>";
      
      const res = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,litecoin&vs_currencies=usd&include_24hr_change=true&include_market_cap=true");
      const data = await res.json();
      
      const cryptos = [
        {name: "Bitcoin", id: "bitcoin", symbol: "BTC"},
        {name: "Ethereum", id: "ethereum", symbol: "ETH"},
        {name: "Litecoin", id: "litecoin", symbol: "LTC"}
      ];
      
      let html = "";
      const prices = [];
      const labels = [];
      const changes = [];
      
      cryptos.forEach(crypto => {
        const price = data[crypto.id].usd || 0;
        const change24h = data[crypto.id].usd_24h_change || 0;
        const changeClass = change24h >= 0 ? "price-up" : "price-down";
        const changeSymbol = change24h >= 0 ? "📈" : "📉";
        
        html += `<div class="crypto-price-card">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <h6 style="margin-bottom:4px;font-weight:600;">${crypto.name} (${crypto.symbol})</h6>
              <p class="muted" style="margin:0;">$${price.toFixed(2)}</p>
            </div>
            <span class="${changeClass}">${changeSymbol} ${change24h.toFixed(2)}%</span>
          </div>
        </div>`;
        
        prices.push(price);
        labels.push(crypto.symbol);
        changes.push(change24h);
      });
      
      document.getElementById("pricesList").innerHTML = html;
      
      if(priceChart) priceChart.destroy();
      const ctx = document.getElementById("priceChart").getContext("2d");
      priceChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: "Price (USD)",
            data: prices,
            backgroundColor: prices.map((p,i) => changes[i] >= 0 ? "#43e97b" : "#f5576c"),
            borderRadius: 8,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value){ return "$"+value.toFixed(0); }
              }
            }
          }
        }
      });
    }catch(err){
      document.getElementById("pricesList").innerHTML = `<p class="error text-center">Error loading prices: ${err.message}</p>`;
    }
  }

  // BOTTOM NAV BUTTONS
  document.getElementById("navSend").addEventListener("click", ()=> showSection("sendSection"));
  document.getElementById("navTop").addEventListener("click", ()=> showSection("topupSection"));
  document.getElementById("navWithdraw").addEventListener("click", ()=> showSection("withdrawSection"));

  // PROFILE
  document.getElementById("uploadProfile").addEventListener("change", (e)=>{
    const f = e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = ()=>{ document.getElementById("profilePic").src = r.result; };
    r.readAsDataURL(f);
  });

  document.getElementById("saveProfileBtn").addEventListener("click", async ()=>{
    try{
      if(!auth.currentUser) return alert("Sign in first");
      const uid = auth.currentUser.uid;
      const name = document.getElementById("profileName").value.trim();
      const newPin = document.getElementById("profileNewPin").value.trim();
      const pic = document.getElementById("profilePic").src || "";
      const updates = { name, profilePic: pic };
      if(newPin){
        if(newPin.length < 4){ document.getElementById("profileMsg").style.display="block"; document.getElementById("profileMsg").innerText="PIN must be 4+ digits"; return; }
        updates.transactionPin = newPin;
      }
      await updateDoc(doc(db,"users",uid), updates);
      document.getElementById("profileMsg").style.display="block";
      document.getElementById("profileMsg").innerText="Profile saved!";
      setTimeout(()=>{ document.getElementById("profileMsg").style.display="none"; },2500);
      document.getElementById("profileNewPin").value="";
      await loadDashboardUI();
    }catch(err){ alert("Save failed: "+err.message); }
  });

  document.getElementById("profileBack").addEventListener("click", ()=> showSection("dashboardSection"));

  async function loadTransactionsView(filterAccount){
    try{
      if(!auth.currentUser) return;
      const uid = auth.currentUser.uid;
      const snap = await getDoc(doc(db, "users", uid));
      const udata = snap.data();
      const txCol = collection(db, "users", uid, "transactions");
      const txSnap = await getDocs(txCol);
      let html = "";
      let title = "Transaction History";
      if(filterAccount === "checking"){ 
        title = "Checking Account - Transaction History";
      } else if(filterAccount === "savings"){ 
        title = "Savings Account - Transaction History";
      }
      document.getElementById("transactionsTitle").innerText = title;
      if(txSnap.empty){
        html = `<p class="muted text-center">No transactions yet</p>`;
      } else {
        const txArray = [];
        txSnap.forEach(doc => {
          txArray.push({id: doc.id, ...doc.data()});
        });
        txArray.sort((a,b) => (b.createdAt?.toMillis?.() || 0) - (a.createdAt?.toMillis?.() || 0));
        txArray.forEach(tx => {
          if(filterAccount){
            const account = filterAccount === "checking" ? udata.checkingAcc : udata.savingsAcc;
            if(tx.from !== account && tx.to !== account) return;
          }
          const amt = (parseFloat(tx.amount) || 0).toFixed(2);
          const fee = (parseFloat(tx.fee) || 0).toFixed(2);
          const status = tx.status || "Success";
          const type = tx.type || "Unknown";
          const from = tx.from || "—";
          const to = tx.to || "—";
          html += `<div style="border-bottom:1px solid #eee;padding:12px 0;font-size:14px;">
            <div style="font-weight:600;margin-bottom:4px;">${type}</div>
            <div class="muted">From: ${from} → To: ${to}</div>
            <div style="margin-top:4px;display:flex;justify-content:space-between;">
              <span style="color:#222;">$${amt}</span>
              <span class="muted">${status}</span>
            </div>
            ${fee > 0 ? `<div class="muted">Fee: $${fee}</div>` : ''}
          </div>`;
        });
      }
      if(!html) html = `<p class="muted text-center">No transactions for this account</p>`;
      document.getElementById("transactionsList").innerHTML = html;
      showSection("transactionsSection");
    }catch(err){
      document.getElementById("transactionsList").innerHTML = `<p class="error">Error loading: ${err.message}</p>`;
      showSection("transactionsSection");
    }
  }

  document.getElementById("signupBtn").addEventListener("click", async ()=>{
    try{
      showError("signupError","");
      const name = document.getElementById("signupName").value.trim();
      const email = document.getElementById("signupEmail").value.trim();
      const password = document.getElementById("signupPassword").value;
      const pin = document.getElementById("signupPin").value.trim();
      if(!name || !email || !password || !pin){ showError("signupError","All required"); return; }
      if(pin.length < 4){ showError("signupError","PIN 4+ digits"); return; }
      const cred = await createUserWithEmailAndPassword(auth,email,password);
      const checkingAcc = genAccountNumber();
      const savingsAcc = genAccountNumber();
      await setDoc(doc(db,"users",cred.user.uid),{
        name, email, checkingBalance:5000, savingsBalance:3000,
        checkingAcc, savingsAcc, transactionPin: pin, profilePic: ""
      });
      alert("Account created! Login now.");
      document.getElementById("signupName").value="";
      document.getElementById("signupEmail").value="";
      document.getElementById("signupPassword").value="";
      document.getElementById("signupPin").value="";
      document.getElementById("loginBox").style.display="block";
      document.getElementById("signupBox").style.display="none";
    }catch(err){ showError("signupError", err.message); }
  });

  document.getElementById("loginBtn").addEventListener("click", async ()=>{
    try{
      showError("loginError","");
      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value;
      if(!email || !password){ showError("loginError","Email and password required"); return; }
      await signInWithEmailAndPassword(auth,email,password);
    }catch(err){ showError("loginError", "Login failed"); }
  });

  async function loadDashboardUI(){
    if(!auth.currentUser) return;
    const uid = auth.currentUser.uid;
    const snap = await getDoc(doc(db,"users",uid));
    if(!snap.exists()) return;
    currentUser = snap.data();
    currentUser.uid = uid;
    document.getElementById("topProfilePic").src = currentUser.profilePic || "https://via.placeholder.com/80";
    document.getElementById("profilePic").src = currentUser.profilePic || "https://via.placeholder.com/80";
    document.getElementById("profileName").value = currentUser.name || "";
    document.getElementById("profileEmail").value = currentUser.email || "";
    document.getElementById("profileWallet").value = currentUser.walletAddress || "";
    document.getElementById("acctMasked").innerText = maskAcc(currentUser.checkingAcc || "");
    document.getElementById("checkingBal").innerText = "$"+(currentUser.checkingBalance || 0).toFixed(2);
    document.getElementById("savingsBal").innerText = "$"+(currentUser.savingsBalance || 0).toFixed(2);
    const holdings = currentUser.cryptoHoldings || {bitcoin: 0, ethereum: 0, litecoin: 0};
    document.getElementById("cryptoHoldings").innerText = `BTC: ${(holdings.bitcoin || 0).toFixed(4)} | ETH: ${(holdings.ethereum || 0).toFixed(4)} | LTC: ${(holdings.litecoin || 0).toFixed(4)}`;
    document.getElementById("overallBalance").innerText = "$"+(((currentUser.checkingBalance||0)+(currentUser.savingsBalance||0))).toFixed(2);
    setGreeting();
  }

  document.getElementById("copyAcct").onclick = () => {
    if(!currentUser) return;
    navigator.clipboard.writeText(currentUser.checkingAcc || "");
  };

  document.getElementById("copyWalletBtn").addEventListener("click", ()=> {
    const wallet = document.getElementById("profileWallet").value;
    if(wallet) navigator.clipboard.writeText(wallet);
  });

  function setGreeting(){ 
    if(!currentUser) return;
    const h = new Date().getHours();
    let g = "Hello"; 
    if(h<12) g="Good morning"; else if(h<18) g="Good afternoon"; else g="Good evening";
    document.getElementById("greeting").innerText = `${g}, ${currentUser.name || ""}`;
    document.getElementById("liveTime").innerText = new Date().toLocaleTimeString();
  }
  setInterval(()=>{ if(currentUser) setGreeting(); },1000);

  document.getElementById("sendBack").addEventListener("click", ()=> showSection("dashboardSection"));
  document.getElementById("topupBack").addEventListener("click", ()=> showSection("dashboardSection"));
  document.getElementById("withdrawBack").addEventListener("click", ()=> showSection("dashboardSection"));
  document.getElementById("wireBack").addEventListener("click", ()=> showSection("dashboardSection"));

  document.getElementById("sendBtn").addEventListener("click", ()=> showSection("sendSection"));
  document.getElementById("topupBtn").addEventListener("click", ()=> showSection("topupSection"));
  document.getElementById("withdrawBtn").addEventListener("click", ()=> showSection("withdrawSection"));
  document.getElementById("wireBtn").addEventListener("click", ()=> showSection("wireSection"));

  document.getElementById("wireAmount").addEventListener("input", ()=>{
    const amt = parseFloat(document.getElementById("wireAmount").value) || 0;
    const fee = (amt * 0.05).toFixed(2);
    document.getElementById("wireFee").innerText = fee;
    document.getElementById("wireTotal").innerText = (amt + parseFloat(fee)).toFixed(2);
  });

  async function recordTransaction(uid, data){
    // Ensure no undefined fields
    const cleanData = {};
    for (let key in data) {
      cleanData[key] = data[key] === undefined ? "" : data[key];
    }
    await addDoc(collection(db,"users",uid,"transactions"), {
      ...cleanData,
      createdAt: serverTimestamp()
    });
  }

  function showReceipt(tx){
    let html = `<p><strong>Type:</strong> ${tx.type}</p>`;
    html += `<p><strong>Amount:</strong> $${(tx.amount||0).toFixed(2)}</p>`;
    if(tx.fee) html += `<p><strong>Fee:</strong> $${(tx.fee||0).toFixed(2)}</p>`;
    html += `<p><strong>From:</strong> ${tx.from || ""}</p>`;
    html += `<p><strong>To:</strong> ${tx.to || ""}</p>`;
    html += `<p><strong>ID:</strong> ${tx.txid}</p>`;
    document.getElementById("receiptTitle").innerText = `${tx.type} Success`;
    document.getElementById("receiptBody").innerHTML = html;
    document.getElementById("receiptModal").style.display = "flex";
  }

  document.getElementById("closeReceiptBtn").addEventListener("click", ()=>{
    document.getElementById("receiptModal").style.display = "none";
    showSection("dashboardSection");
  });

  // TOP UP
  document.getElementById("topupSubmit").addEventListener("click", async ()=>{
    try{
      showError("topupError","");
      if(!auth.currentUser){ alert("Sign in"); return; }
      const uid = auth.currentUser.uid;
      const amt = parseFloat(document.getElementById("topupAmount").value);
      const pin = document.getElementById("topupPin").value.trim();
      if(!amt || amt <= 0 || isNaN(amt)) { showError("topupError","Valid amount"); return; }
      const snap = await getDoc(doc(db,"users",uid));
      if(!snap.exists()){ showError("topupError","User not found"); return; }
      const udata = snap.data();
      if(!udata.checkingAcc){ showError("topupError","Account not set up"); return; }
      if(udata.transactionPin !== pin){ showError("topupError","Wrong PIN"); return; }
      const txid = genTxID();
      const userRef = doc(db,"users",uid);
      await runTransaction(db, async (transaction) => {
        const userDoc = await transaction.get(userRef);
        if (!userDoc.exists()) throw new Error("User not found");
        const userData = userDoc.data();
        transaction.update(userRef, {
          checkingBalance: (userData.checkingBalance || 0) + amt
        });
      });
      await recordTransaction(uid, {
        type: "Top-up", amount: amt, fee: 0, total: amt,
        from: "External", to: udata.checkingAcc || "", status: "Success", txid: txid
      });
      await loadDashboardUI();
      document.getElementById("topupAmount").value="";
      document.getElementById("topupPin").value="";
      showReceipt({type:"Top-up", amount:amt, from:"External", to:udata.checkingAcc || "", txid:txid});
    }catch(err){ showError("topupError", err.message); }
  });

  // WITHDRAW
  document.getElementById("withdrawSubmit").addEventListener("click", async ()=>{
    try{
      showError("withdrawError","");
      if(!auth.currentUser){ alert("Sign in"); return; }
      const uid = auth.currentUser.uid;
      const amt = parseFloat(document.getElementById("withdrawAmount").value);
      const pin = document.getElementById("withdrawPin").value.trim();
      if(!amt || amt <= 0 || isNaN(amt)) { showError("withdrawError","Valid amount"); return; }
      const snap = await getDoc(doc(db,"users",uid));
      if(!snap.exists()){ showError("withdrawError","User not found"); return; }
      const udata = snap.data();
      if(!udata.checkingAcc){ showError("withdrawError","Account not set up"); return; }
      if(udata.transactionPin !== pin){ showError("withdrawError","Wrong PIN"); return; }
      const txid = genTxID();
      const userRef = doc(db,"users",uid);
      await runTransaction(db, async (transaction) => {
        const userDoc = await transaction.get(userRef);
        const userData = userDoc.data();
        if((userData.checkingBalance || 0) < amt) throw new Error("Insufficient");
        transaction.update(userRef, {
          checkingBalance: (userData.checkingBalance || 0) - amt
        });
      });
      await recordTransaction(uid, {
        type: "Withdraw", amount: amt, fee: 0, total: amt,
        from: udata.checkingAcc || "", to: "External", status: "Success", txid: txid
      });
      await loadDashboardUI();
      document.getElementById("withdrawAmount").value="";
      document.getElementById("withdrawPin").value="";
      showReceipt({type:"Withdraw", amount:amt, from:udata.checkingAcc || "", to:"External", txid:txid});
    }catch(err){ showError("withdrawError", err.message); }
  });

  // SEND
  document.getElementById("sendSubmit").addEventListener("click", async ()=>{
    try{
      showError("sendError","");
      if(!auth.currentUser){ alert("Sign in"); return; }
      const uid = auth.currentUser.uid;
      const toAcc = document.getElementById("sendTo").value.trim();
      const amt = parseFloat(document.getElementById("sendAmount").value);
      const pin = document.getElementById("sendPin").value.trim();
      if(!toAcc || !amt || amt <= 0 || isNaN(amt)){ showError("sendError","Fill all fields"); return; }
      const snap = await getDoc(doc(db,"users",uid));
      const udata = snap.data();
      if(udata.transactionPin !== pin){ showError("sendError","Wrong PIN"); return; }
      if(toAcc === udata.checkingAcc || toAcc === udata.savingsAcc){ showError("sendError","Cannot send to yourself"); return; }
      const fee = (amt * 0.01).toFixed(2);
      const total = amt + parseFloat(fee);
      const q1 = query(collection(db,"users"), where("checkingAcc","==",toAcc));
      let recipientSnap = await getDocs(q1);
      if(recipientSnap.empty){
        const q2 = query(collection(db,"users"), where("savingsAcc","==",toAcc));
        recipientSnap = await getDocs(q2);
      }
      if(recipientSnap.empty){ showError("sendError","Recipient not found"); return; }
      const recipientUid = recipientSnap.docs[0].id;
      const txid = genTxID();
      const senderRef = doc(db,"users",uid);
      const recipientRef = doc(db,"users",recipientUid);
      await runTransaction(db, async (transaction) => {
        const senderDoc = await transaction.get(senderRef);
        const recipientDoc = await transaction.get(recipientRef);
        if (!senderDoc.exists() || !recipientDoc.exists()) throw new Error("User not found");
        const senderData = senderDoc.data();
        if((senderData.checkingBalance || 0) < total) throw new Error("Insufficient");
        transaction.update(senderRef, {
          checkingBalance: (senderData.checkingBalance || 0) - total
        });
        const recipientData = recipientDoc.data();
        transaction.update(recipientRef, {
          checkingBalance: (recipientData.checkingBalance || 0) + amt
        });
      });
      await recordTransaction(uid, {
        type:"Send", amount: amt, fee: parseFloat(fee), total, from: udata.checkingAcc, to: toAcc, status:"Success", txid: txid
      });
      const recipientData = recipientSnap.docs[0].data();
      await recordTransaction(recipientUid, {
        type:"Received", amount: amt, fee: 0, total: amt, from: udata.checkingAcc, to: recipientData.checkingAcc || "", status:"Success", txid: txid
      });
      await loadDashboardUI();
      document.getElementById("sendTo").value="";
      document.getElementById("sendAmount").value="";
      document.getElementById("sendPin").value="";
      showReceipt({type:"Send", amount:amt, fee:parseFloat(fee), from:udata.checkingAcc, to:toAcc, txid:txid});
    }catch(err){ showError("sendError", err.message); }
  });

  // CRYPTO
  document.getElementById("cryptoSubmit").addEventListener("click", async ()=>{
    try{
      showError("cryptoError","");
      if(!auth.currentUser){ alert("Sign in"); return; }
      const uid = auth.currentUser.uid;
      const crypto = document.getElementById("cryptoType").value;
      const amt = parseFloat(document.getElementById("cryptoAmount").value);
      const pin = document.getElementById("cryptoPin").value.trim();
      if(!amt || amt <= 0 || isNaN(amt)) { showError("cryptoError","Valid amount"); return; }
      const snap = await getDoc(doc(db,"users",uid));
      if(!snap.exists()){ showError("cryptoError","User not found"); return; }
      const udata = snap.data();
      if(!udata.checkingAcc){ showError("cryptoError","Account not set up"); return; }
      if(udata.transactionPin !== pin){ showError("cryptoError","Wrong PIN"); return; }
      const fee = (amt * 0.02).toFixed(2);
      const total = amt + parseFloat(fee);
      const txid = genTxID();
      const userRef = doc(db,"users",uid);
      const cryptoType = crypto.split(" ")[0].toLowerCase();
      const cryptoKey = cryptoType === "bitcoin" ? "bitcoin" : cryptoType === "ethereum" ? "ethereum" : "litecoin";
      await runTransaction(db, async (transaction) => {
        const userDoc = await transaction.get(userRef);
        if (!userDoc.exists()) throw new Error("User not found");
        const userData = userDoc.data();
        if((userData.checkingBalance || 0) < total) throw new Error("Insufficient");
        const holdings = userData.cryptoHoldings || {bitcoin: 0, ethereum: 0, litecoin: 0};
        transaction.update(userRef, {
          checkingBalance: (userData.checkingBalance || 0) - total,
          cryptoHoldings: {
            ...holdings,
            [cryptoKey]: (holdings[cryptoKey] || 0) + amt
          }
        });
      });
      await recordTransaction(uid, {
        type: "Buy Crypto", amount: amt, fee: parseFloat(fee), total,
        from: udata.checkingAcc || "", to: crypto, status: "Success", txid: txid
      });
      await loadDashboardUI();
      document.getElementById("cryptoAmount").value="";
      document.getElementById("cryptoPin").value="";
      showReceipt({type:"Buy Crypto", amount:amt, fee:parseFloat(fee), from:udata.checkingAcc || "", to:crypto, txid:txid});
    }catch(err){ showError("cryptoError", err.message); }
  });

  // Temporary storage for crypto confirmation
  let cryptoConfirmData = null;

  // SEND CRYPTO - Show Confirmation Modal
  document.getElementById("sendCryptoSubmit").addEventListener("click", async ()=>{
    try{
      showError("sendCryptoError","");
      if(!auth.currentUser){ alert("Sign in"); return; }
      const uid = auth.currentUser.uid;
      const toWallet = document.getElementById("sendCryptoTo").value.trim();
      const cryptoTypeStr = document.getElementById("sendCryptoType").value;
      const cryptoType = cryptoTypeStr.split(" ")[0].toLowerCase();
      const cryptoKey = cryptoType === "bitcoin" ? "bitcoin" : cryptoType === "ethereum" ? "ethereum" : "litecoin";
      const amt = parseFloat(document.getElementById("sendCryptoAmount").value);
      const pin = document.getElementById("sendCryptoPin").value.trim();
      
      if(!toWallet || !amt || amt <= 0 || isNaN(amt)) { showError("sendCryptoError","Fill all fields"); return; }
      if(!toWallet.startsWith("0x")) { showError("sendCryptoError","Invalid wallet (start with 0x)"); return; }
      
      const snap = await getDoc(doc(db,"users",uid));
      if(!snap.exists()){ showError("sendCryptoError","User not found"); return; }
      const udata = snap.data();
      if(udata.transactionPin !== pin){ showError("sendCryptoError","Wrong PIN"); return; }
      if((udata.cryptoHoldings[cryptoKey] || 0) < amt){ showError("sendCryptoError","Insufficient "+cryptoKey); return; }
      
      const q = query(collection(db,"users"), where("walletAddress","==",toWallet));
      const recipSnap = await getDocs(q);
      if(recipSnap.empty){ showError("sendCryptoError","Recipient wallet not found"); return; }
      
      cryptoConfirmData = {
        uid, amt, pin, toWallet, cryptoType, cryptoKey, udata, recipSnap, txid: genTxID()
      };
      
      document.getElementById("confirmAmount").innerText = amt + " " + cryptoType.toUpperCase();
      document.getElementById("confirmCrypto").innerText = cryptoTypeStr;
      document.getElementById("confirmFrom").innerText = udata.walletAddress.slice(0,10) + "..." + udata.walletAddress.slice(-8);
      document.getElementById("confirmTo").innerText = toWallet.slice(0,10) + "..." + toWallet.slice(-8);
      document.getElementById("cryptoConfirmModal").style.display = "flex";
    }catch(err){ showError("sendCryptoError", err.message); }
  });

  // Cancel Confirmation
  document.getElementById("cancelCryptoConfirm").addEventListener("click", ()=>{
    document.getElementById("cryptoConfirmModal").style.display = "none";
    cryptoConfirmData = null;
  });

  // Confirm and Execute Transfer
  document.getElementById("confirmCryptoTransfer").addEventListener("click", async ()=>{
    try{
      if(!cryptoConfirmData) return;
      const {uid, amt, toWallet, cryptoKey, udata, recipSnap, txid} = cryptoConfirmData;
      const recipientUid = recipSnap.docs[0].id;
      const senderRef = doc(db,"users",uid);
      const recipientRef = doc(db,"users",recipientUid);
      
      await runTransaction(db, async (transaction) => {
        const senderDoc = await transaction.get(senderRef);
        const recipientDoc = await transaction.get(recipientRef);
        if(!senderDoc.exists() || !recipientDoc.exists()) throw new Error("User not found");
        const senderData = senderDoc.data();
        if((senderData.cryptoHoldings[cryptoKey] || 0) < amt) throw new Error("Insufficient");
        transaction.update(senderRef, {
          cryptoHoldings: {
            ...senderData.cryptoHoldings,
            [cryptoKey]: (senderData.cryptoHoldings[cryptoKey] || 0) - amt
          }
        });
        const recData = recipientDoc.data();
        transaction.update(recipientRef, {
          cryptoHoldings: {
            ...recData.cryptoHoldings,
            [cryptoKey]: (recData.cryptoHoldings[cryptoKey] || 0) + amt
          }
        });
      });
      
      await recordTransaction(uid, {
        type: "Send Crypto", amount: amt, fee: 0, total: amt,
        from: udata.walletAddress, to: toWallet, status: "Success", txid: txid
      });
      await recordTransaction(recipientUid, {
        type: "Received Crypto", amount: amt, fee: 0, total: amt,
        from: udata.walletAddress, to: toWallet, status: "Success", txid: txid
      });
      
      document.getElementById("cryptoConfirmModal").style.display = "none";
      await loadDashboardUI();
      document.getElementById("sendCryptoTo").value="";
      document.getElementById("sendCryptoAmount").value="";
      document.getElementById("sendCryptoPin").value="";
      showReceipt({type:"Send Crypto", amount:amt+" "+cryptoKey.toUpperCase(), from:udata.walletAddress, to:toWallet, txid:txid});
      cryptoConfirmData = null;
    }catch(err){ 
      showError("sendCryptoError", err.message);
      document.getElementById("cryptoConfirmModal").style.display = "none";
      cryptoConfirmData = null;
    }
  });

  // WIRE
  document.getElementById("wireSubmit").addEventListener("click", async ()=>{
    try{
      showError("wireError","");
      if(!auth.currentUser){ alert("Sign in"); return; }
      const uid = auth.currentUser.uid;
      const bank = document.getElementById("wireBank").value.trim();
      const name = document.getElementById("wireName").value.trim();
      const acc = document.getElementById("wireAcc").value.trim();
      const country = document.getElementById("wireCountry").value;
      const amt = parseFloat(document.getElementById("wireAmount").value);
      const pin = document.getElementById("wirePin").value.trim();
      if(!bank||!name||!acc||!amt||amt <= 0 || isNaN(amt)){ showError("wireError","Fill all"); return; }
      const snap = await getDoc(doc(db,"users",uid));
      const udata = snap.data();
      if(udata.transactionPin !== pin){ showError("wireError","Wrong PIN"); return; }
      const fee = (amt * 0.05).toFixed(2);
      const total = amt + parseFloat(fee);
      const txid = genTxID();
      const userRef = doc(db,"users",uid);
      await runTransaction(db, async (transaction) => {
        const userDoc = await transaction.get(userRef);
        const userData = userDoc.data();
        if((userData.checkingBalance || 0) < total) throw new Error("Insufficient");
        transaction.update(userRef, {
          checkingBalance: (userData.checkingBalance || 0) - total
        });
      });
      await recordTransaction(uid, {
        type: "Wire Transfer", amount: amt, fee: parseFloat(fee), total,
        from: udata.checkingAcc, to: `${name} | ${bank} | ${country}`, status: "Success", txid: txid
      });
      await loadDashboardUI();
      document.getElementById("wireBank").value="";
      document.getElementById("wireName").value="";
      document.getElementById("wireAcc").value="";
      document.getElementById("wireAmount").value="";
      document.getElementById("wirePin").value="";
      document.getElementById("wireFee").innerText="0.00";
      document.getElementById("wireTotal").innerText="0.00";
      showReceipt({type:"Wire Transfer", amount:amt, fee:parseFloat(fee), from:udata.checkingAcc, to:name, txid:txid});
    }catch(err){ showError("wireError", err.message); }
  });
  </script>
</body>
</html>