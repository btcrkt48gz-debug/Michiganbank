<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CredCrypt - Digital Banking</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            width: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            color: #1f2937;
            overflow-x: hidden;
        }

        body.dark-mode {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #f1f5f9;
        }

        .page {
            display: none;
            min-height: 100vh;
            width: 100%;
        }

        .page.active {
            display: flex;
        }

        /* Auth Pages */
        .auth-page {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auth-box {
            background: white;
            border-radius: 24px;
            padding: 40px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode .auth-box {
            background: #1e293b;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .auth-box h2 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .auth-box p {
            color: #6b7280;
            margin-bottom: 32px;
            font-size: 14px;
        }

        body.dark-mode .auth-box p {
            color: #9ca3af;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
            color: #1f2937;
        }

        body.dark-mode .form-group label {
            color: #f1f5f9;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.2s;
            background: #f9fafb;
        }

        body.dark-mode .form-group input {
            background: #0f172a;
            border-color: #334155;
            color: #f1f5f9;
        }

        .form-group input:focus {
            outline: none;
            border-color: #8b5cf6;
            background: white;
        }

        body.dark-mode .form-group input:focus {
            background: #1e293b;
        }

        .auth-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            margin-top: 24px;
            transition: all 0.3s;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(139, 92, 246, 0.3);
        }

        .auth-link {
            text-align: center;
            margin-top: 16px;
            font-size: 14px;
            color: #6b7280;
        }

        body.dark-mode .auth-link {
            color: #9ca3af;
        }

        .auth-link a {
            color: #8b5cf6;
            cursor: pointer;
            text-decoration: none;
            font-weight: 600;
        }

        /* Dashboard */
        .dashboard-page {
            flex-direction: column;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        body.dark-mode .header {
            background: #1e293b;
            border-bottom: 1px solid #334155;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .header-btn {
            background: #f3f4f6;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            transition: all 0.2s;
            color: #1f2937;
        }

        body.dark-mode .header-btn {
            background: #334155;
            color: #f1f5f9;
        }

        .header-btn:hover {
            background: #e5e7eb;
        }

        body.dark-mode .header-btn:hover {
            background: #475569;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .content-grid {
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .greeting {
            margin-bottom: 8px;
        }

        .greeting h2 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .greeting p {
            font-size: 14px;
            color: #6b7280;
        }

        body.dark-mode .greeting p {
            color: #9ca3af;
        }

        /* Account Cards */
        .account-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .account-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
        }

        body.dark-mode .account-card {
            background: #1e293b;
            border-color: #334155;
        }

        .account-card .label {
            font-size: 13px;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 12px;
        }

        body.dark-mode .account-card .label {
            color: #9ca3af;
        }

        .account-card .amount {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .account-card button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .account-card button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.3);
        }

        /* Total Balance */
        .total-card {
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            color: white;
            border-radius: 20px;
            padding: 32px;
        }

        .total-card .label {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .total-card .amount {
            font-size: 48px;
            font-weight: 700;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 20px;
            border-bottom: 2px solid #e5e7eb;
            padding: 0;
        }

        body.dark-mode .tabs {
            border-bottom: 2px solid #334155;
        }

        .tab {
            background: none;
            border: none;
            padding: 12px 0;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            color: #9ca3af;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .tab.active {
            color: #8b5cf6;
            border-bottom-color: #8b5cf6;
        }

        /* Card List */
        .card-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }

        .card {
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .card:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 30px rgba(139, 92, 246, 0.3);
        }

        .card-name {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 12px;
        }

        .card-price {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .card-info {
            font-size: 12px;
            opacity: 0.9;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 32px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        body.dark-mode .modal-content {
            background: #1e293b;
        }

        .modal-header {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 24px;
            text-align: center;
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: #f3f4f6;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            color: #1f2937;
        }

        body.dark-mode .modal-close {
            background: #334155;
            color: #f1f5f9;
        }

        /* Pin Grid */
        .pin-display {
            text-align: center;
            font-size: 32px;
            letter-spacing: 12px;
            margin: 24px 0;
            height: 40px;
            font-weight: 700;
        }

        .pin-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .pin-btn {
            padding: 16px;
            font-size: 18px;
            font-weight: 600;
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pin-btn:hover {
            transform: translateY(-2px);
        }

        .pin-btn:active {
            transform: translateY(0);
        }

        /* Input Fields */
        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 8px;
            color: #1f2937;
        }

        body.dark-mode .input-group label {
            color: #f1f5f9;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            background: #f9fafb;
            color: #1f2937;
        }

        body.dark-mode .input-group input,
        body.dark-mode .input-group select {
            background: #0f172a;
            border-color: #334155;
            color: #f1f5f9;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #8b5cf6;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(139, 92, 246, 0.3);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #1f2937;
            width: 100%;
        }

        body.dark-mode .btn-secondary {
            background: #334155;
            color: #f1f5f9;
        }

        /* Transactions */
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
        }

        body.dark-mode .transaction-item {
            border-bottom: 1px solid #334155;
        }

        .transaction-item:hover {
            background: #f9fafb;
        }

        body.dark-mode .transaction-item:hover {
            background: #0f172a;
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-type {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .transaction-date {
            font-size: 12px;
            color: #9ca3af;
        }

        .transaction-amount {
            font-weight: 700;
            font-size: 16px;
        }

        .transaction-positive {
            color: #10b981;
        }

        .transaction-negative {
            color: #ef4444;
        }

        @media (max-width: 640px) {
            .account-cards {
                grid-template-columns: 1fr;
            }

            .auth-box {
                padding: 24px;
            }

            .greeting h2 {
                font-size: 24px;
            }

            .total-card .amount {
                font-size: 36px;
            }

            .account-card .amount {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>

<!-- Login Page -->
<div id="loginPage" class="page auth-page">
    <div class="auth-box">
        <h2>CredCrypt</h2>
        <p>Welcome back! Sign in to continue</p>
        <div id="loginError" style="display:none; color: #ef4444; font-size: 13px; margin-bottom: 16px;"></div>
        <form onsubmit="handleLogin(event)">
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="loginEmail" placeholder="test@example.com" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="password123" required>
            </div>
            <button type="submit" class="auth-btn">Sign In</button>
        </form>
        <div class="auth-link">
            Don't have an account? <a onclick="switchPage('signup')">Sign Up</a>
        </div>
    </div>
</div>

<!-- Signup Page -->
<div id="signupPage" class="page auth-page" style="display:none;">
    <div class="auth-box">
        <h2>CredCrypt</h2>
        <p>Create your account</p>
        <div id="signupError" style="display:none; color: #ef4444; font-size: 13px; margin-bottom: 16px;"></div>
        <form onsubmit="handleSignup(event)" style="max-height: 400px; overflow-y: auto;">
            <div class="form-group">
                <label>First Name</label>
                <input type="text" id="firstName" placeholder="John" required>
            </div>
            <div class="form-group">
                <label>Last Name</label>
                <input type="text" id="lastName" placeholder="Doe" required>
            </div>
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="signupEmail" placeholder="you@example.com" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="signupPassword" placeholder="Enter password" required>
            </div>
            <div class="form-group">
                <label>Confirm Password</label>
                <input type="password" id="confirmPassword" placeholder="Confirm password" required>
            </div>
            <div class="form-group">
                <label>Admin Code (Optional)</label>
                <input type="password" id="adminCode" placeholder="CredCrypt2024">
            </div>
            <button type="submit" class="auth-btn">Sign Up</button>
        </form>
        <div class="auth-link">
            Already have an account? <a onclick="switchPage('login')">Login</a>
        </div>
    </div>
</div>

<!-- Dashboard Page -->
<div id="dashboardPage" class="page dashboard-page" style="display:none;">
    <div class="header">
        <h1>CredCrypt</h1>
        <div class="header-actions">
            <button class="header-btn" onclick="toggleDarkMode()">üåô Dark Mode</button>
            <button class="header-btn" onclick="handleLogout()">Logout</button>
        </div>
    </div>

    <div class="main-content">
        <div class="content-grid">
            <div class="greeting">
                <h2 id="greeting">Good Morning, Jacob!</h2>
                <p id="dayName">Tuesday, Nov 25</p>
            </div>

            <!-- Account Cards -->
            <div class="account-cards">
                <div class="account-card">
                    <div class="label">Checking Account</div>
                    <div class="amount" id="checkingAmount">$1,298.00</div>
                    <button onclick="showModal('topup')">Add Funds</button>
                </div>
                <div class="account-card">
                    <div class="label">Savings Account</div>
                    <div class="amount" id="savingsAmount">$0.00</div>
                    <button onclick="showModal('transfer')">Transfer</button>
                </div>
            </div>

            <!-- Total Balance -->
            <div class="total-card">
                <div class="label">Total Balance</div>
                <div class="amount" id="totalAmount">$1,298.00</div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('dashboard')">Dashboard</button>
                <button class="tab" onclick="switchTab('crypto')">Crypto</button>
                <button class="tab" onclick="switchTab('transactions')">Transactions</button>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboardTab">
                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">Recent Transactions</h3>
                <div id="transactionsList" style="background: white; border-radius: 12px; overflow: hidden;">
                    <div style="padding: 20px; text-align: center; color: #9ca3af;">No transactions yet</div>
                </div>
            </div>

            <!-- Crypto Tab -->
            <div id="cryptoTab" style="display:none;">
                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">Cryptocurrencies</h3>
                <div class="card-list" id="cryptoList"></div>
            </div>

            <!-- Transactions Tab -->
            <div id="transactionsTab" style="display:none;">
                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">All Transactions</h3>
                <div id="allTransactionsList" style="background: white; border-radius: 12px; overflow: hidden;">
                    <div style="padding: 20px; text-align: center; color: #9ca3af;">No transactions yet</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Top Up Modal -->
<div id="topupModal" class="modal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeModal('topup')">√ó</button>
        <div class="modal-header">Add Funds</div>
        <div class="input-group">
            <label>Amount (USD)</label>
            <input type="number" id="topupAmount" placeholder="100.00" step="0.01" min="0">
        </div>
        <button class="btn btn-primary" onclick="handleTopUp()">Add Funds</button>
    </div>
</div>

<!-- Transfer Modal -->
<div id="transferModal" class="modal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeModal('transfer')">√ó</button>
        <div class="modal-header">Transfer Money</div>
        <div class="input-group">
            <label>From Account</label>
            <select id="transferFrom">
                <option value="checking">Checking</option>
                <option value="savings">Savings</option>
            </select>
        </div>
        <div class="input-group">
            <label>To Account</label>
            <select id="transferTo">
                <option value="savings">Savings</option>
                <option value="checking">Checking</option>
            </select>
        </div>
        <div class="input-group">
            <label>Amount</label>
            <input type="number" id="transferAmount" placeholder="0.00" step="0.01" min="0">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <button class="btn btn-secondary" onclick="closeModal('transfer')">Cancel</button>
            <button class="btn btn-primary" onclick="handleTransfer()">Transfer</button>
        </div>
    </div>
</div>

<!-- Buy Crypto Modal -->
<div id="buyCryptoModal" class="modal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeModal('buyCrypto')">√ó</button>
        <div class="modal-header" id="cryptoTitle">Buy Bitcoin</div>
        <div id="cryptoPriceLabel" style="text-align: center; color: #6b7280; margin-bottom: 20px; font-size: 14px;"></div>
        <div class="input-group">
            <label>USD Amount</label>
            <input type="number" id="cryptoAmount" placeholder="100.00" step="0.01" min="0" oninput="updateCryptoCalculation()">
        </div>
        <div id="cryptoCalc" style="text-align: center; color: #6b7280; margin: 16px 0; font-size: 13px;"></div>
        <button class="btn btn-primary" onclick="proceedToPIN()">Proceed to PIN</button>
    </div>
</div>

<!-- PIN Modal -->
<div id="pinModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">Enter PIN</div>
        <div id="pinError" style="display:none; color: #ef4444; font-size: 13px; margin-bottom: 16px; text-align: center;"></div>
        <div class="pin-display" id="pinDisplay">‚óè‚óè‚óè‚óè</div>
        <div class="pin-grid" id="pinGrid"></div>
        <button class="btn btn-primary" onclick="submitPIN()">Confirm</button>
    </div>
</div>

<!-- Receipt Modal -->
<div id="receiptModal" class="modal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeModal('receipt')">√ó</button>
        <div class="modal-header">Transaction Receipt</div>
        <div id="receiptContent" style="text-align: center; padding: 20px; color: #10b981; font-weight: 600;"></div>
        <button class="btn btn-primary" onclick="closeModal('receipt')">Done</button>
    </div>
</div>

<script>
    let auth = null;
    let db = null;
    let currentUser = null;
    let userData = null;
    let darkMode = localStorage.getItem('darkMode') === 'true';
    let currentCryptoData = null;
    let pinBuffer = '';
    let cryptoPrices = {
        BTC: 45230,
        ETH: 2850,
        ADA: 1.45,
        SOL: 98
    };

    const firebaseConfig = {
        apiKey: "AIzaSyDl1hgfXs5k_XiGXJh8mN2pQrR_2vZ8K4w",
        authDomain: "credcrypt-e80c0.firebaseapp.com",
        projectId: "credcrypt-e80c0",
        storageBucket: "credcrypt-e80c0.firebasestorage.app",
        messagingSenderId: "847611883266",
        appId: "1:847611883266:web:7f3d2d4e8f9g0h1i2j3k"
    };

    function initApp() {
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        auth = firebase.auth();
        db = firebase.firestore();
        
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                loadUserData();
                switchPage('dashboard');
            } else {
                switchPage('login');
            }
        });

        initPinGrid();
        updateGreeting();
    }

    function handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        const errorDiv = document.getElementById('loginError');

        auth.signInWithEmailAndPassword(email, password).catch(error => {
            errorDiv.textContent = error.message;
            errorDiv.style.display = 'block';
        });
    }

    function handleSignup(e) {
        e.preventDefault();
        const firstName = document.getElementById('firstName').value;
        const lastName = document.getElementById('lastName').value;
        const email = document.getElementById('signupEmail').value;
        const password = document.getElementById('signupPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const adminCode = document.getElementById('adminCode').value;
        const errorDiv = document.getElementById('signupError');

        if (password !== confirmPassword) {
            errorDiv.textContent = 'Passwords do not match';
            errorDiv.style.display = 'block';
            return;
        }

        auth.createUserWithEmailAndPassword(email, password).then(result => {
            const isAdmin = adminCode === 'CredCrypt2024';
            db.collection('users').doc(result.user.uid).set({
                firstName,
                lastName,
                email,
                checking: 1500,
                savings: 0,
                cryptoHoldings: {},
                transactions: [],
                pin: '1234',
                isAdmin,
                createdAt: new Date()
            });
            alert('Account created! Please sign in.');
            switchPage('login');
        }).catch(error => {
            errorDiv.textContent = error.message;
            errorDiv.style.display = 'block';
        });
    }

    function handleLogout() {
        auth.signOut();
    }

    async function loadUserData() {
        const doc = await db.collection('users').doc(currentUser.uid).get();
        if (doc.exists()) {
            userData = doc.data();
            updateUI();
        }
    }

    function updateUI() {
        const total = userData.checking + userData.savings;
        document.getElementById('totalAmount').textContent = `$${total.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
        document.getElementById('checkingAmount').textContent = `$${userData.checking.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
        document.getElementById('savingsAmount').textContent = `$${userData.savings.toLocaleString('en-US', {minimumFractionDigits: 2})}`;

        const transactions = userData.transactions || [];
        const transHTML = transactions.length ? transactions.slice(0, 5).map(t => {
            const isNeg = ['buy', 'transfer', 'send'].includes(t.type);
            return `
                <div class="transaction-item">
                    <div class="transaction-info">
                        <div class="transaction-type">${t.type}</div>
                        <div class="transaction-date">${new Date(t.timestamp).toLocaleDateString()}</div>
                    </div>
                    <div class="transaction-amount ${isNeg ? 'transaction-negative' : 'transaction-positive'}">
                        ${isNeg ? '-' : '+'}$${Math.abs(t.amount).toFixed(2)}
                    </div>
                </div>
            `;
        }).join('') : '<div style="padding: 20px; text-align: center; color: #9ca3af;">No transactions</div>';

        document.getElementById('transactionsList').innerHTML = transHTML;
        document.getElementById('allTransactionsList').innerHTML = transHTML;

        const cryptoHTML = Object.entries(cryptoPrices).map(([symbol, price]) => {
            const holding = userData.cryptoHoldings?.[symbol] || 0;
            const value = holding * price;
            return `
                <div class="card" onclick="buyCrypto('${symbol}', ${price})">
                    <div class="card-name">${symbol}</div>
                    <div class="card-price">$${price.toFixed(2)}</div>
                    <div class="card-info">Holdings: ${holding.toFixed(8)} | $${value.toFixed(2)}</div>
                </div>
            `;
        }).join('');
        document.getElementById('cryptoList').innerHTML = cryptoHTML;
    }

    async function handleTopUp() {
        const amount = parseFloat(document.getElementById('topupAmount').value);
        if (!amount || amount <= 0) return alert('Enter valid amount');

        await db.collection('users').doc(currentUser.uid).update({
            checking: userData.checking + amount,
            transactions: firebase.firestore.FieldValue.arrayUnion({
                id: 'topup-' + Date.now(),
                type: 'top-up',
                amount,
                timestamp: new Date(),
                status: 'completed'
            })
        });

        await loadUserData();
        closeModal('topup');
        document.getElementById('topupAmount').value = '';
        alert('Top up successful!');
    }

    async function handleTransfer() {
        const from = document.getElementById('transferFrom').value;
        const to = document.getElementById('transferTo').value;
        const amount = parseFloat(document.getElementById('transferAmount').value);

        if (!amount || amount <= 0) return alert('Enter valid amount');
        if (userData[from] < amount) return alert('Insufficient balance');

        const newFrom = userData[from] - amount;
        const newTo = userData[to] + amount;

        await db.collection('users').doc(currentUser.uid).update({
            [from]: newFrom,
            [to]: newTo,
            transactions: firebase.firestore.FieldValue.arrayUnion({
                id: 'transfer-' + Date.now(),
                type: 'transfer',
                from,
                to,
                amount: -amount,
                timestamp: new Date(),
                status: 'completed'
            })
        });

        await loadUserData();
        closeModal('transfer');
        document.getElementById('transferAmount').value = '';
        alert('Transfer successful!');
    }

    function buyCrypto(symbol, price) {
        currentCryptoData = { symbol, price };
        document.getElementById('cryptoTitle').textContent = `Buy ${symbol}`;
        document.getElementById('cryptoPriceLabel').textContent = `Price: $${price.toFixed(2)} per ${symbol}`;
        showModal('buyCrypto');
    }

    function updateCryptoCalculation() {
        const usd = parseFloat(document.getElementById('cryptoAmount').value) || 0;
        const crypto = usd / currentCryptoData.price;
        document.getElementById('cryptoCalc').textContent = `${crypto.toFixed(8)} ${currentCryptoData.symbol} for $${usd.toFixed(2)}`;
    }

    function proceedToPIN() {
        const amount = document.getElementById('cryptoAmount').value;
        if (!amount || amount <= 0) return alert('Enter valid amount');
        pinBuffer = '';
        updatePinDisplay();
        showModal('buyCrypto', false);
        showModal('pin');
    }

    function initPinGrid() {
        const grid = document.getElementById('pinGrid');
        for (let i = 1; i <= 9; i++) {
            const btn = document.createElement('button');
            btn.className = 'pin-btn';
            btn.textContent = i;
            btn.type = 'button';
            btn.onclick = () => addPin(i);
            grid.appendChild(btn);
        }

        const clearBtn = document.createElement('button');
        clearBtn.className = 'pin-btn';
        clearBtn.textContent = 'Clear';
        clearBtn.style.gridColumn = 'span 2';
        clearBtn.type = 'button';
        clearBtn.onclick = () => { pinBuffer = ''; updatePinDisplay(); };
        grid.appendChild(clearBtn);

        const btn0 = document.createElement('button');
        btn0.className = 'pin-btn';
        btn0.textContent = '0';
        btn0.type = 'button';
        btn0.onclick = () => addPin(0);
        grid.appendChild(btn0);
    }

    function addPin(num) {
        if (pinBuffer.length < 4) {
            pinBuffer += num;
            updatePinDisplay();
        }
    }

    function updatePinDisplay() {
        const display = '‚óè'.repeat(pinBuffer.length) + '‚óã'.repeat(4 - pinBuffer.length);
        document.getElementById('pinDisplay').textContent = display;
    }

    async function submitPIN() {
        if (pinBuffer !== userData.pin) {
            document.getElementById('pinError').textContent = 'Incorrect PIN';
            document.getElementById('pinError').style.display = 'block';
            return;
        }

        const usd = parseFloat(document.getElementById('cryptoAmount').value);
        const crypto = usd / currentCryptoData.price;

        if (userData.checking < usd) return alert('Insufficient balance');

        const holdings = userData.cryptoHoldings || {};
        holdings[currentCryptoData.symbol] = (holdings[currentCryptoData.symbol] || 0) + crypto;

        await db.collection('users').doc(currentUser.uid).update({
            checking: userData.checking - usd,
            cryptoHoldings: holdings,
            transactions: firebase.firestore.FieldValue.arrayUnion({
                id: 'crypto-' + Date.now(),
                type: 'buy',
                symbol: currentCryptoData.symbol,
                amount: -usd,
                cryptoAmount: crypto,
                timestamp: new Date(),
                status: 'completed'
            })
        });

        await loadUserData();
        closeModal('pin');
        document.getElementById('receiptContent').textContent = '‚úì Transaction successful!';
        showModal('receipt');
        pinBuffer = '';
    }

    function switchPage(page) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(page + 'Page').classList.add('active');
    }

    function switchTab(tab) {
        document.getElementById('dashboardTab').style.display = 'none';
        document.getElementById('cryptoTab').style.display = 'none';
        document.getElementById('transactionsTab').style.display = 'none';
        document.getElementById(tab + 'Tab').style.display = 'block';

        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
    }

    function showModal(id, show = true) {
        document.getElementById(id + 'Modal').classList.toggle('active', show);
    }

    function closeModal(id) {
        document.getElementById(id + 'Modal').classList.remove('active');
    }

    function toggleDarkMode() {
        darkMode = !darkMode;
        localStorage.setItem('darkMode', darkMode);
        document.body.classList.toggle('dark-mode', darkMode);
    }

    function updateGreeting() {
        const now = new Date();
        const hours = now.getHours();
        const greeting = hours < 12 ? 'Good Morning' : hours < 18 ? 'Good Afternoon' : 'Good Evening';
        document.getElementById('greeting').textContent = `${greeting}, ${userData?.firstName || 'User'}!`;
        document.getElementById('dayName').textContent = now.toLocaleDateString('en-US', {weekday: 'long', month: 'short', day: 'numeric'});
    }

    if (darkMode) document.body.classList.add('dark-mode');
    initApp();
</script>

</body>
</html>